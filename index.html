<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="ForecastFramework Demo" />


<title></title>
<!-- Material Design fonts -->
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="index_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<link href="index_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
<script src="index_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
<link href="index_files/bootstrap_material-0.1/bootstrap-material-design.min.css" rel="stylesheet" />
<link href="index_files/bootstrap_material-0.1/ripples.min.css" rel="stylesheet" />
<script src="index_files/bootstrap_material-0.1/material.min.js"></script>
<script src="index_files/bootstrap_material-0.1/ripples.min.js"></script>
<link href="index_files/material-0.1/material.css" rel="stylesheet" />
<script src="index_files/material-0.1/material.js"></script>
<script src="index_files/kePrint-0.0.1/kePrint.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->

</head>

<body>

<div class="header-panel shadow z-2">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-3">
        <div id="header">
    <h1 class="title"><img src="images/logo.png" style="width:100px;"></h1>
                <h4 class="author"><em>ForecastFramework Demo</em></h4>
                </div>
    </div>
</div>
</div>
</div>


<div class="container-fluid main-container">
    <div class="row">
      <nav class="col-xs-3 menu" id="toc">
        <ul>
        <li><a href="#about-forecastframework"><strong>About</strong> ForecastFramework</a></li>
        <li><a href="#getting-started"><strong>Getting Started</strong></a></li>
        <li><a href="#the-data-1"><strong>The Data</strong></a></li>
        <li><a href="#defining-inputs-incidence-matrix-1"><strong>Defining Inputs</strong> Incidence Matrix</a></li>
        <li><a href="#fitting-and-forecasting-sarimatd-1"><strong>Fitting and Forecasting</strong> SARIMATD</a></li>
        <li><a href="#evaluating-complex-models-sarimatd-sarima-gam-1"><strong>Evaluating Complex Models</strong> SARIMATD, SARIMA, GAM</a></li>
        <li><a href="#creating-your-own-model-sarimatd-1"><strong>Creating your own Model</strong> SARIMATD</a></li>
        </ul>
      </nav>
     <div class="pages col-xs-9">
     <div class="row">
       <div class="col-xs-10">



<div id="about-forecastframework" class="section level1">
<h1><strong>About</strong> ForecastFramework</h1>
<div id="purpose" class="section level3">
<h3>Purpose</h3>
<p>ForecastFramework is an object-oriented R package that standardizes forecasting models. The package uses the <a href="https://www.r-project.org/nosvn/pandoc/R6.html">R6 class implementation</a> to design an object-oriented framework for building forecasting models for spatial time-series data. The central goals of the ForecastFramework package are to enable <strong>rapid model development</strong> while <strong>standardizing and simplifying implementation</strong> and <strong>performance evaluation</strong>.</p>
</div>
<div id="usage" class="section level3">
<h3>Usage</h3>
<p>ForecastFramework is the primary modeling tool used at the <a href="http://reichlab.io/">Reich Lab</a> at the University of Massachusetts Amherst. Specifically, it is the modeling format used in the Predict the District Challenge.</p>
<p>The following diagram illustrates the flow of a ForecastFramework Modeling process:</p>
<p><img src="images/ff_diagram_overview.png" class="large"></p>
</div>
<div id="creation" class="section level3">
<h3>Creation</h3>
<p>ForecastFramework was created by Joshua Kaminsky of the <a href="http://www.iddynamics.jhsph.edu/">Infectious Disease Dynamics Group</a> at Johns Hopkins University. This demo was created by <a href="www.github.com/katiehouse3">Katie House</a>.</p>
<p><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>.</p>
</div>
</div>
<div id="getting-started" class="section level1">
<h1><strong>Getting Started</strong></h1>
<div id="installation" class="section level3">
<h3>Installation</h3>
<p>ForecastFramework is an open source R package hosted on <a href="https://cran.r-project.org/web/packages/ForecastFramework/index.html">CRAN</a> and <a href="https://github.com/HopkinsIDD/ForecastFramework">Github</a>.</p>
<p>To install this package, either run the following commands in your <a href="https://www.rstudio.com/">Rstudio</a> console:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&#39;ForecastFramework&#39;</span>)</code></pre></div>
<p>Or:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(devtools)
devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&#39;HopkinsIDD/ForecastFramework&#39;</span>)</code></pre></div>
</div>
<div id="the-forecastframework-pipeline" class="section level3">
<h3>The ForecastFramework Pipeline</h3>
<p>Before creating your own ForecastFramework models, letâ€™s dive deeper into the forecasting process with ForecastFramework.</p>
<p>Below is a very basic example of the ForecastFramework pipeline: preprocessing, fitting, forecasting, and evaluating: <img src="images/ff_pipeline.png" class="large"></p>
<p>Each of the subsequent vignettes looks into a part of this process. However, the preprocesing stage will be included in the Defining Inputs Vignette.</p>
</div>
<div id="vignette-overview" class="section level3">
<h3>Vignette Overview:</h3>
<ul>
<li><h4 id="the-data"><code>The Data</code></h4>
This section will examines the raw data used in the ForecastFramework models ahead.</li>
<li><h4 id="defining-inputs-incidence-matrix"><code>Defining Inputs: Incidence Matrix</code></h4>
(<em>Beginner Section</em>) This section will define what an Incidence Matrix is, show how to format your data to be used as an Incidence Matrix, and exemplify functions of Incidence Matrices.</li>
<li><h4 id="fitting-and-forecasting-sarimatd"><code>Fitting and Forecasting: SARIMATD</code></h4>
(<em>Beginner Section</em>)This section will focus on fitting data to a SARIMA model with ForecastFramework.</li>
<li><h4 id="evaluating-complex-models-sarimatd-sarima-gam"><code>Evaluating Complex Models: SARIMATD, SARIMA, GAM</code></h4>
(<em>Intermediate Section</em>) This section will demonstrate evaluation metrics and techniques by comparing two complex models in ForecastFramework.</li>
<li><h4 id="creating-your-own-model-sarimatd"><code>Creating your own Model: SARIMATD</code></h4>
(<em>Advanced Section</em>) This section will demonstrate how to create your own model with ForecastFramework. NOTE: This section requires object-oriented programming knowledge.</li>
</ul>
</div>
</div>
<div id="the-data-1" class="section level1">
<h1><strong>The Data</strong></h1>
<div id="demo-data-cdc-u.s.-flu-season-data" class="section level3">
<h3>Demo Data: CDC U.S. Flu Season Data</h3>
<p>This demonstration uses state influenza statistics maintained by the U.S. Centers for Disease Control (CDC). Normally, the data include all 50 US states. For simplicity, this demo only models national data. These data are quickly retrieved with the following library: <a href="https://github.com/hrbrmstr/cdcfluview" class="uri">https://github.com/hrbrmstr/cdcfluview</a>.</p>
<p>Weighted ILI stands for Weighted Influenze-Like Illness. This is a metric for the amount of patients seen with a fever, a cough and/or sore throat, and no other causes of the symptoms over the total patient visits, and then weighted on the basis of state population. More infomation about these data can be found at: <a href="https://www.cdc.gov/flu/weekly/overview.htm" class="uri">https://www.cdc.gov/flu/weekly/overview.htm</a>.</p>
<div id="raw-data" class="section level4">
<h4>Raw Data</h4>
<p>These data include many attributes, but we will focus on: <code>region</code>,<code>year</code>,<code>week</code>,<code>weighted_ili</code>,<code>week_start</code>. <code>cases</code> is the aggegate sum of Dengue Fever cases for that specific year and biweek.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(cdcfluview)
<span class="kw">library</span>(dplyr)
dat &lt;-<span class="st"> </span><span class="kw">ilinet</span>(<span class="dt">region =</span> <span class="st">&quot;National&quot;</span>)
dat &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;week&#39;</span>,<span class="st">&#39;weighted_ili&#39;</span>, <span class="st">&#39;week_start&#39;</span>)
<span class="kw">print</span>(<span class="kw">head</span>(dat,<span class="dv">6</span>))</code></pre></div>
<pre><code>## # A tibble: 6 x 5
##   region    year  week weighted_ili week_start
##   &lt;chr&gt;    &lt;int&gt; &lt;int&gt;        &lt;dbl&gt; &lt;date&gt;    
## 1 National  1997    40         1.10 1997-10-06
## 2 National  1997    41         1.20 1997-10-13
## 3 National  1997    42         1.38 1997-10-20
## 4 National  1997    43         1.20 1997-10-27
## 5 National  1997    44         1.66 1997-11-03
## 6 National  1997    45         1.41 1997-11-10</code></pre>
</div>
<div id="time-series" class="section level4">
<h4>Time Series</h4>
<p>A time series of the raw data looks like the following: <img src="index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="scope-of-this-demo" class="section level4">
<h4>Scope of this demo</h4>
<p>This demo will model and entire year starting from the beginning of the flu season in 2016.</p>
</div>
</div>
</div>
<div id="defining-inputs-incidence-matrix-1" class="section level1">
<h1><strong>Defining Inputs</strong> Incidence Matrix</h1>
<div id="what-is-an-incidencematrix" class="section level3">
<h3>What is an IncidenceMatrix?</h3>
<p>ForecastFramework makes it easy to quickly manipulate forecasting data. To do this, create an object from a class called IncidenceMatrix. IncidenceMatrices are the stanard inputs for ForecastFramework models. This vignette describes how to create an IncidenceMatrix and some key fields and methods relating to their usage.</p>
</div>
<div id="incidencematrix-in-the-forecastframework-process" class="section level3">
<h3>IncidenceMatrix in the ForecastFramework Process</h3>
<p><img src="images/IncidenceMatrixDia.png" class="large"></p>
</div>
<div id="how-to-create-an-incidencematrix" class="section level3">
<h3>How to create an IncidenceMatrix</h3>
<ol style="list-style-type: decimal">
<li>Make sure you import <code>ForecastFramework</code> and <code>R6</code></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(R6)
<span class="kw">library</span>(ForecastFramework)</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Create a new matrix with your data</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_matrix &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,<span class="dv">3</span>,<span class="dv">3</span>)
<span class="kw">print</span>(data_matrix)</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Create a new IncidenceMatrix object with your data</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data_matrix)</code></pre></div>
</div>
<div id="list-incidencematrix-fields" class="section level3">
<h3>List IncidenceMatrix Fields</h3>
<p>The IncidenceMatrix class has several fields that can be helpful for data preprocessing.</p>
<ul>
<li><code>$mat</code> show data in matrix form</li>
<li><code>$nrow</code> number of rows</li>
<li><code>$ncol</code> number of columns</li>
<li><code>$colData</code> columns headers</li>
<li><code>$rowData</code> row names</li>
<li><code>$cellData</code> list of cell metadata</li>
<li><code>$cnames</code> names of matrix columns</li>
<li><code>$rnames</code> names of matrix rows</li>
<li><code>$metaData</code> any data not part of main matrix</li>
</ul>
</div>
<div id="methods" class="section level3">
<h3>Methods</h3>
<p>In object oriented programming, a â€˜methodâ€™ is a function for a class. In this case, the following methods are functions that are applied to IncidenceMatrix.</p>
<ul>
<li><code>$addColumns(n)</code> add <code>n</code> columns to matrix</li>
<li><code>$addRows(n)</code> add <code>n</code> rows to matrix</li>
<li><code>$diff(n)</code> difference between each column and lag <code>n</code> columns to the left</li>
<li><code>$lag(n)</code> lag each columns by <code>n</code></li>
<li><code>$head(x,y)</code> show <code>x</code> columns/rows from the top (<code>y</code>=1 for columns, 2 for rows)</li>
<li><code>$tail(x,y)</code> show <code>x</code> columns/rows from the bottom (<code>y</code>=1 for columns, 2 for rows)</li>
<li><code>$scale(functin(x){})</code> scale the matrix by some function</li>
<li><code>$subset(rows=x,cols=y)</code> take a subset of the matrix by <code>x</code> rows and <code>y</code> columns</li>
</ul>
</div>
<div id="field-examples" class="section level3">
<h3>Field Examples</h3>
<p>Letâ€™s apply some of the example functions from above to our <code>data_object</code>.</p>
<p><strong>$mat</strong> show data in matrix form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>mat</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9</code></pre>
<p></br><strong>$nrow</strong> number of rows in the matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>nrow</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p></br><strong>$ncol</strong> number of columns in the matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>ncol</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p></br><strong>$colData</strong> Edit or the column names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>colData &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="co"># Initialize how many columns headers</span>
data_object<span class="op">$</span>colData &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;C&quot;</span>))
data_object<span class="op">$</span>colData</code></pre></div>
<pre><code>## [[1]]
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot;</code></pre>
<p></br><strong>$addColumns</strong> Edit or the column names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span><span class="kw">addColumns</span>(<span class="dv">2</span>)
data_object<span class="op">$</span>colData</code></pre></div>
<pre><code>## [[1]]
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; NA  NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>mat</code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]    1    4    7   NA   NA
## [2,]    2    5    8   NA   NA
## [3,]    3    6    9   NA   NA</code></pre>
</div>
</div>
<div id="fitting-and-forecasting-sarimatd-1" class="section level1">
<h1><strong>Fitting and Forecasting</strong> SARIMATD</h1>
<div id="about-sarimatd" class="section level3">
<h3>About SARIMATD</h3>
<p>This demonstration investigates the usage of models with ForecastFramework. <a href="https://github.com/reichlab/sarimaTD">SARIMATD</a> is a new R package created by Evan Ray of the Reich Lab. SARIMATD stands for SARIMA with Transformations and Seasonal Differencing. SARIMATD is a model composed of a set of wrapper functions that simplify estimating and predicting traditional SARIMA models. These wrapper functions first transform the incidence data to approximate normality, then perform seasonal differencing, and input the new incidence data to the <code>forecast::auto.arima</code> function from the Forecast package.</p>
</div>
<div id="fitting-the-forecastframework-sarimatd-model" class="section level3">
<h3>Fitting the ForecastFramework SARIMATD Model</h3>
<div id="import-packages" class="section level4">
<h4>1. Import packages</h4>
<p>First you must import all the required libraries. Note that ForecastFramework doesnâ€™t requre <code>dplyr</code> or <code>ggplot2</code>, but they will be used to make a figure at the end of the demo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(R6)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(cdcfluview)

<span class="co"># Source R6 Files</span>
<span class="kw">library</span>(RCurl)

<span class="co"># Function of Source Github Models</span>
source_github &lt;-<span class="st"> </span><span class="cf">function</span>(u) {
  <span class="co"># read script lines from website and evaluate</span>
  script &lt;-<span class="st"> </span><span class="kw">getURL</span>(u, <span class="dt">ssl.verifypeer =</span> <span class="ot">FALSE</span>)
  <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> script),<span class="dt">envir=</span>.GlobalEnv)
}  
<span class="co"># Source R6 Files</span>
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/ContestModel.R&#39;</span>)
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/SARIMATD1Model.R&#39;</span>)</code></pre></div>
<p>Now it is time to fit your SARIMATD Model! ForecastFramework makes this easy.</p>
</div>
<div id="create-new-sarimatdmodel-class" class="section level4">
<h4>2. Create new SARIMATDmodel Class</h4>
<p>In this SARIMATD model, simulation is used with <code>::forecast auto.arima()</code>. So we must define the number of simulations to use, <code>nsim</code>. We also need to define the seasonal periodicity of our data, or the <code>period</code> parameter. For this forecast, we know the periodicity is 52, because the data is weekly. once we define these parameters, they can be passed into the <code>SARIMATDModel()</code> class generator to create a new <code>sarimaTDmodel</code> class.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nsim &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co"># Number of SARIMA simulations </span>
sarimaTDmodel &lt;-<span class="st"> </span>SARIMATD1Model<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">52</span>, <span class="dt">nsim =</span> nsim)</code></pre></div>
</div>
<div id="import-cdc-flu-data" class="section level4">
<h4>3. Import CDC Flu Data</h4>
<p>To import the fluview data, use the <code>ilinet()</code> command. The data is then filtered to remove unneeded weeks and years. Then, the data is stored as an <code>IncidenceMatrix()</code>. An incidence matrix represents spatial time-series data in a matrix with one row per location and one column per time. To do this, another series of transformations are made. IncidenceMatrix is the preferred input for ForecastFramework Models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data2 &lt;-<span class="st"> </span><span class="kw">ilinet</span>(<span class="dt">region =</span> <span class="st">&quot;National&quot;</span>)
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>( week <span class="op">!=</span><span class="st"> </span><span class="dv">53</span>)
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2009</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">          </span>year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2018</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">          </span><span class="op">!</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;</span><span class="st"> </span><span class="dv">18</span>))
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;week&#39;</span>,<span class="st">&#39;weighted_ili&#39;</span>, <span class="st">&#39;week_start&#39;</span>)

<span class="co"># Create a Preprocess Function</span>
preprocess_inc &lt;-<span class="st"> </span><span class="cf">function</span>(dat){
  dat<span class="op">$</span>time.in.year =<span class="st"> </span>dat<span class="op">$</span>week
  dat<span class="op">$</span>t =<span class="st"> </span>dat<span class="op">$</span>year <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>week<span class="op">/</span><span class="dv">52</span>
  inc =<span class="st"> </span>ObservationList<span class="op">$</span><span class="kw">new</span>(dat)
  inc<span class="op">$</span><span class="kw">formArray</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;t&#39;</span>,<span class="dt">val=</span><span class="st">&#39;weighted_ili&#39;</span>,
                <span class="dt">dimData =</span> <span class="kw">list</span>(<span class="ot">NULL</span>,<span class="kw">list</span>(<span class="st">&#39;week&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;time.in.year&#39;</span>,<span class="st">&#39;t&#39;</span>)),
                <span class="dt">metaData =</span> <span class="kw">list</span>(<span class="dt">t.step =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">52</span>,<span class="dt">max.year.time =</span> <span class="dv">52</span>))
  <span class="kw">return</span>(inc)
}

<span class="co"># Seperate into Training and Testing Data</span>
training_data &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( <span class="op">!</span><span class="st"> </span>((year <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;=</span><span class="st"> </span><span class="dv">19</span>)<span class="op">|</span><span class="st"> </span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> ) ))
testing_data &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>((year <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;=</span><span class="st"> </span><span class="dv">19</span>) <span class="op">|</span><span class="st"> </span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&lt;=</span><span class="st"> </span><span class="dv">18</span>) )

training_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(training_data)
testing_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(testing_data)</code></pre></div>
<p>Letâ€™s look at a sample from the new IncidenceMatrix to view the IncidenceMatrix Format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(training_inc<span class="op">$</span>mat[,<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>])</code></pre></div>
<pre><code>## 2010.01923076923 2010.03846153846 2010.05769230769 2010.07692307692 
##          1.90712          1.86738          1.88072          1.96908 
## 2010.09615384615 2010.11538461538 2010.13461538462 2010.15384615385 
##          2.11387          2.09695          1.90294          1.96951 
## 2010.17307692308 2010.19230769231 
##          1.92331          1.89659</code></pre>
<p>Notice that the traditional dates have been transformed to fractions of a year.</p>
</div>
<div id="fit-the-model" class="section level4">
<h4>3. Fit the Model</h4>
<p>Typically, different regions would be fit separately and have different forecasts. For the scope of this demo, we are only fitting and forecasting national data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sarimaTDmodel<span class="op">$</span><span class="kw">fit</span>(training_inc)</code></pre></div>
</div>
</div>
<div id="forecasting-with-the-forecastframework-sarima-model" class="section level3">
<h3>Forecasting with the ForecastFramework SARIMA Model</h3>
<div id="forecasting-sarima" class="section level4">
<h4>4. Forecasting SARIMA</h4>
<p>Before forecasting, you must specify how many periods ahead you would like to forecast. This is defined by the <code>steps</code> parameter. Then, you forecast with the <code>sarimaTDmodel$forecast()</code> method. This model will forecast one year into the future (26 biweeks).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define how many provinces to model</span>
<span class="co"># this demo only has data for one province: Province 10</span>
steps &lt;-<span class="st"> </span><span class="dv">52</span> <span class="co"># forecast ahead 30 epiweeks</span></code></pre></div>
<p>Then, use the built-in <code>$forecast()</code> function to create your forecasts. This creates a new R6 object with your forecasts and many other useful built-in functions. Be sure to check out the Evaluation section for usage of the Forecasting function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">forecast_X &lt;-<span class="st"> </span>sarimaTDmodel<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">steps =</span> steps)</code></pre></div>
</div>
</div>
<div id="plotting-the-output" class="section level3">
<h3>Plotting the Output</h3>
<div id="formatting-the-forecast-output" class="section level4">
<h4>5. Formatting the Forecast Output</h4>
<p>To view the new forecasting data in matrix form, execute the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">forecast_X<span class="op">$</span>data<span class="op">$</span>mat</code></pre></div>
<pre><code>##                 1        2        3        4        5        6        7
## National 1.494988 1.434023 1.305924 1.377093 1.277542 1.118989 1.107131
##                 8        9        10       11       12        13        14
## National 1.154718 1.075546 0.9737291 1.012862 0.968587 0.9295113 0.7956496
##                 15        16        17       18       19       20       21
## National 0.8622301 0.8591591 0.9388838 1.078237 1.289133 1.398952 1.492972
##               22       23       24       25      26       27       28
## National 1.60926 1.751339 1.542025 1.653691 1.66884 1.773896 1.632859
##                29       30       31       32       33       34       35
## National 1.857147 2.038057 2.382388 2.746086 3.745335 4.282143 2.835912
##                36       37       38       39       40       41       42
## National 2.686989 2.657029 2.691704 2.983318 3.318447 3.182371 2.847058
##                43       44       45       46       47       48       49
## National 3.019881 3.161179 2.587937 2.261168 2.166532 2.030118 1.869631
##                50       51       52
## National 1.842289 1.811737 1.579724</code></pre>
<p>Lets convert the forecast matrix to a dataframe in R for easy manipulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># converting predictions to a dataframe to use dplyr</span>
preds_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">as.table</span>(<span class="kw">t</span>(forecast_X<span class="op">$</span>data<span class="op">$</span>mat)))</code></pre></div>
<p>To include the <code>date_sick</code> in the <code>forecast_X$data$mat</code> output, map the forecast to its predicted dates is to create a new data frame with the data from the missing year. Then, we will combine the output in <code>forecast_X$data</code> with the correct biweek dates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># converting predictions to a dataframe to use dplyr</span>
<span class="co"># import testing dataset which has 2013 data</span>

<span class="co"># add prediction dates to original forecast</span>
preds_df[[<span class="st">&quot;date_sick&quot;</span>]] &lt;-<span class="kw">as.Date</span>(testing_data<span class="op">$</span>week_start, <span class="dt">format =</span> <span class="st">&quot;%d-%m-%Y&quot;</span>)</code></pre></div>
<p>Now, we can add the forecast to the <code>preds_df</code>. Notice the <code>$median()</code> and <code>$quantile()</code> functions accompanied with <code>$mat</code> will produce matricies with the prediction medians and quantiles, respectively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">preds_df &lt;-<span class="st"> </span>preds_df <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw">mutate</span>( 
      <span class="dt">pred_total_cases =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">median</span>(<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.025</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.975</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.05</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.95</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.25</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.75</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat)
   )
<span class="kw">print</span>(<span class="kw">head</span>(preds_df,<span class="dv">5</span>)) <span class="co"># Print the first 5 rows</span></code></pre></div>
<pre><code>##   Var1     Var2     Freq  date_sick pred_total_cases pred_95_lb pred_95_ub
## 1    1 National 1.494988 2016-05-09         1.584742   1.492623   1.738221
## 2    2 National 1.434023 2016-05-16         1.526748   1.372367   1.736432
## 3    3 National 1.305924 2016-05-23         1.443575   1.307798   1.609338
## 4    4 National 1.377093 2016-05-30         1.418816   1.313325   1.604585
## 5    5 National 1.277542 2016-06-06         1.301111   1.182285   1.463765
##   pred_80_lb pred_80_ub pred_50_lb pred_50_ub
## 1   1.493310   1.724331   1.521874   1.686489
## 2   1.378031   1.698894   1.452463   1.545781
## 3   1.309672   1.600059   1.326824   1.525930
## 4   1.321713   1.603285   1.382052   1.473694
## 5   1.182317   1.461521   1.243019   1.416048</code></pre>
</div>
<div id="plot-the-forecast-output" class="section level4">
<h4>6. Plot the Forecast Output</h4>
<p>Finally, you are able to plot your SARIMATD Forecast! Lets use <code>ggplot2</code> to create a cool plot. ### Weighted ILI SARIMATD Forecast <img src="index_files/figure-html/unnamed-chunk-31-1.png" width="960" /></p>
</div>
</div>
</div>
<div id="evaluating-complex-models-sarimatd-sarima-gam-1" class="section level1">
<h1><strong>Evaluating Complex Models</strong> SARIMATD, SARIMA, GAM</h1>
<div id="evaluating-complex-models" class="section level3">
<h3>Evaluating Complex Models</h3>
<p>This tutorial will demonstrate how to easily compare multiple models on ForecastFramework. One of the best advantages of ForecastFramework is the ability to evaluate many models at once with the same functions.</p>
<div id="preprocessing-data" class="section level4">
<h4>Preprocessing Data</h4>
<p>Import libraries and source models</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(R6)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(cdcfluview)
<span class="kw">library</span>(gridExtra)
<span class="kw">library</span>(data.table)
<span class="kw">library</span>(knitr)
<span class="kw">library</span>(kableExtra)
<span class="kw">library</span>(RCurl)

<span class="co"># Function of Source Github Models</span>
source_github &lt;-<span class="st"> </span><span class="cf">function</span>(u) {
  <span class="co"># read script lines from website and evaluate</span>
  script &lt;-<span class="st"> </span><span class="kw">getURL</span>(u, <span class="dt">ssl.verifypeer =</span> <span class="ot">FALSE</span>)
  <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> script),<span class="dt">envir=</span>.GlobalEnv)
}  
<span class="co"># Source R6 Files</span>
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/ContestModel.R&#39;</span>)
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/SARIMAModel.R&#39;</span>)
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/GamModel.R&#39;</span>)
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/SARIMATD1Model.R&#39;</span>)</code></pre></div>
<p>Upload data from cdcfluview as dataframes. In this demo, we are only concerned with years between 2010 and 2017. We split training/testing data by excluding the 2016-17 Flu season in the training set.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data &lt;-<span class="st"> </span><span class="kw">ilinet</span>(<span class="dt">region =</span> <span class="st">&quot;National&quot;</span>)
data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>( week <span class="op">!=</span><span class="st"> </span><span class="dv">53</span>)
data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2009</span> <span class="op">&amp;</span><span class="st"> </span>year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2018</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">          </span><span class="op">!</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;</span><span class="st"> </span><span class="dv">18</span>))
data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;week&#39;</span>,<span class="st">&#39;weighted_ili&#39;</span>, <span class="st">&#39;week_start&#39;</span>)

<span class="co"># Seperate into Training and Testing Data</span>
training_data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( <span class="op">!</span><span class="st"> </span>((year <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;=</span><span class="st"> </span><span class="dv">19</span>)<span class="op">|</span><span class="st"> </span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> ) ))
testing_data &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>((year <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;=</span><span class="st"> </span><span class="dv">19</span>) <span class="op">|</span><span class="st"> </span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&lt;=</span><span class="st"> </span><span class="dv">18</span>) )</code></pre></div>
<p>A <strong>sample of the data</strong> we are forecasting.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(testing_data,<span class="dv">5</span>)</code></pre></div>
<pre><code>## # A tibble: 5 x 5
##   region    year  week weighted_ili week_start
##   &lt;chr&gt;    &lt;int&gt; &lt;int&gt;        &lt;dbl&gt; &lt;date&gt;    
## 1 National  2016    19         1.39 2016-05-09
## 2 National  2016    20         1.30 2016-05-16
## 3 National  2016    21         1.18 2016-05-23
## 4 National  2016    22         1.14 2016-05-30
## 5 National  2016    23         1.04 2016-06-06</code></pre>
<p>Then, preprocess both the training and testing dataframes to become new incidence matrices. This script uses the <code>ObservationList$new()</code> ForecastFramework function to easily convert the dataframe to an incidence matrix. The <code>$formArray()</code> is the second step to complete the incidence matrix.</p>
<p>Note: The time step in this example is 52 weeks; however, there are datasets with 26 biweeks or other time intervals used in the <code>t.step</code>, <code>dat$t</code>, and <code>max.year.time</code> values.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create a Preprocess Function</span>
<span class="co"># Convert Training and Testing data to incidence matrices</span>
<span class="co"># time.in.year is a requirement for the GAM model</span>
preprocess_inc &lt;-<span class="st"> </span><span class="cf">function</span>(dat){
  dat<span class="op">$</span>time.in.year =<span class="st"> </span>dat<span class="op">$</span>week
  dat<span class="op">$</span>t =<span class="st"> </span>dat<span class="op">$</span>year <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>week<span class="op">/</span><span class="dv">52</span>
  inc =<span class="st"> </span>ObservationList<span class="op">$</span><span class="kw">new</span>(dat)
  inc<span class="op">$</span><span class="kw">formArray</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;t&#39;</span>,<span class="dt">val=</span><span class="st">&#39;weighted_ili&#39;</span>,
                <span class="dt">dimData =</span> <span class="kw">list</span>(<span class="ot">NULL</span>,<span class="kw">list</span>(<span class="st">&#39;week&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;time.in.year&#39;</span>,<span class="st">&#39;t&#39;</span>)),
                <span class="dt">metaData =</span> <span class="kw">list</span>(<span class="dt">t.step =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">52</span>,<span class="dt">max.year.time =</span> <span class="dv">52</span>))
  <span class="kw">return</span>(inc)
}

<span class="co"># Preprocess Data and convert to Inc Mat</span>
training_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(training_data)
testing_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(testing_data)</code></pre></div>
</div>
<div id="defining-models" class="section level4">
<h4>Defining Models</h4>
<p>This demo will be evaluating the GAM, SARIMA, and SARIMATD model given different evaluation metrics.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Defining the Models</span>
nsim &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># Number of simulations </span>
region_num &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># Only modeling the &quot;National&quot; region</span>

sarimaTD_model &lt;-<span class="st"> </span>SARIMATD1Model<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">52</span>, <span class="dt">nsim =</span> nsim)
sarima_model &lt;-<span class="st"> </span>SARIMAModel<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">52</span>, <span class="dt">nsim =</span> nsim)
gam_model &lt;-<span class="st"> </span>GamModel<span class="op">$</span><span class="kw">new</span>(<span class="dt">numProvinces =</span> region_num,<span class="dt">nSims =</span> nsim)</code></pre></div>
</div>
<div id="fitting-models" class="section level4">
<h4>Fitting Models</h4>
<p>Each model is fit with the training data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fit the Models </span>
sarimaTD_model<span class="op">$</span><span class="kw">fit</span>(training_inc)
sarima_model<span class="op">$</span><span class="kw">fit</span>(training_inc)
gam_model<span class="op">$</span><span class="kw">fit</span>(training_inc)</code></pre></div>
</div>
<div id="forecasting-models" class="section level4">
<h4>Forecasting Models</h4>
<p>We are forecasting from the beginning of flu season 2016-17, 52 weeks into the future.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Forecasting the Models</span>
steps &lt;-<span class="st"> </span><span class="dv">52</span> <span class="co"># forecast ahead 26 biweeks</span>
forecast_sarimaTD &lt;-<span class="st"> </span>sarimaTD_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">step =</span> steps)
forecast_sarima &lt;-<span class="st"> </span>sarima_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">step =</span> steps)
forecast_gam &lt;-<span class="st"> </span>gam_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">step =</span> steps)</code></pre></div>
</div>
<div id="evaluating-the-models" class="section level4">
<h4>Evaluating the Models</h4>
<p>Now for the fun part! How did the models perform? This question is easy to answer with ForecastFramework Models.</p>
<p><strong>Important Note:</strong> This is not a formal model evaluation or comparison. The goal of this exercise is to demonstrate different ForecastFramework techniques. Although the SARIMATD model appears to perform better than the other models in this example, a more in-depth analysis must be made before any conclusions can be made about model performance.</p>
<p><strong>Side-by-Side Forecasting Timeseries</strong> This function creates a time series visualization with the predicted median and quantiles displayed by a specific color. Notice <code>forecast$quantile(0.025)$mat</code> gives a matrix with a 2.5% quantile. Additionally, <code>forecast$mean()$mat</code> gives the mean forecast for that specific time period. Additionally, <code>na.rm=TRUE</code>, removes any NA values in the simulation to calculate the mean.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Function to create time series with Visualization</span>
visualize_model &lt;-<span class="st"> </span><span class="cf">function</span>(forecast, rib_color, main_color){
  data_X_3years &lt;-<span class="st"> </span>data <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2013</span>)
  preds_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">as.table</span>(<span class="kw">t</span>(forecast<span class="op">$</span>data<span class="op">$</span>mat)))
  preds_df[[<span class="st">&quot;week_start&quot;</span>]] &lt;-<span class="kw">as.Date</span>(testing_data<span class="op">$</span>week_start, <span class="dt">format =</span> <span class="st">&quot;%Y-%d-%m&quot;</span>)
  preds_df &lt;-<span class="st"> </span>preds_df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>( 
      <span class="dt">pred_total_cases =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">mean</span>(<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.025</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.975</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.05</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.95</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.25</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.75</span>,<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat)
    )
  plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> week_start, <span class="dt">ymin =</span> pred_95_lb, <span class="dt">ymax =</span> pred_95_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> week_start, <span class="dt">ymin =</span> pred_80_lb, <span class="dt">ymax =</span> pred_80_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> week_start, <span class="dt">ymin =</span> pred_50_lb, <span class="dt">ymax =</span> pred_50_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> week_start, <span class="dt">y =</span> pred_total_cases),
      <span class="dt">color =</span> main_color,
      <span class="dt">size =</span> <span class="dv">1</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> week_start, <span class="dt">y =</span> weighted_ili),
              <span class="dt">size=</span><span class="fl">0.7</span>,
              <span class="dt">data =</span> data_X_3years) <span class="op">+</span>
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Weighted ILI&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">13</span>))
  <span class="kw">return</span>(plot)
}

<span class="co"># Create each plot</span>
plot1 &lt;-<span class="st"> </span><span class="kw">visualize_model</span>(forecast_sarimaTD, <span class="st">&quot;palegreen3&quot;</span>, <span class="st">&quot;forestgreen&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;SARIMATD&quot;</span>)
plot2 &lt;-<span class="st"> </span><span class="kw">visualize_model</span>(forecast_sarima, <span class="st">&quot;coral1&quot;</span>, <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;SARIMA&quot;</span>)
plot3 &lt;-<span class="st"> </span><span class="kw">visualize_model</span>(forecast_gam, <span class="st">&quot;cornflowerblue&quot;</span> , <span class="st">&quot;blue&quot;</span>)<span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;GAM&quot;</span>)

<span class="co"># Display side-by-side plots</span>
<span class="kw">grid.arrange</span>(plot1, plot2, plot3, <span class="dt">ncol=</span><span class="dv">3</span>)</code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-39-1.png" width="1056" /> Note the sparcity in the SARIMA forecast. This is one benefit of SARIMATD - the ability to provide long-term forecasts with the aid of transformations and seasonal differencing.</p>
<p><strong>Common Evaluation Metrics</strong> Calculating evaluation metrics is easy with ForecastFramework objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Mean Absolute Error</span>
MAE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_mean, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_mean
  abs_err &lt;-<span class="st"> </span><span class="kw">abs</span>(err)
  <span class="kw">return</span>(<span class="kw">mean</span>(abs_err))
}
<span class="co"># Mean Squared Error</span>
MSE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_mean, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_mean
  err_sq &lt;-<span class="st"> </span>err<span class="op">^</span><span class="dv">2</span>
  <span class="kw">return</span>(<span class="kw">mean</span>(err_sq))
}
<span class="co"># Mean Absolute Percentage Error</span>
MAPE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_mean, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_mean
  abs_err &lt;-<span class="st"> </span><span class="kw">abs</span>(err)
  abs_err_percent &lt;-<span class="st"> </span>abs_err<span class="op">/</span>test_inc<span class="op">$</span>mat
  <span class="kw">return</span>(<span class="kw">mean</span>(abs_err_percent)<span class="op">*</span><span class="dv">100</span>)
}
<span class="co"># Root Mean Squared Error</span>
RMSE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_mean, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_mean
  err_sq &lt;-<span class="st"> </span>err<span class="op">^</span><span class="dv">2</span>
  mse &lt;-<span class="kw">mean</span>(err_sq)
  <span class="kw">return</span>(<span class="kw">sqrt</span>(mse))
}</code></pre></div>
<p>Each Model can be evaluated given the various functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create Arrays with each Metric</span>
evaluate &lt;-<span class="st"> </span><span class="cf">function</span>(forecast){
  <span class="co"># Replace any NaN values with 0</span>
  forecast_mat &lt;-<span class="st"> </span>forecast<span class="op">$</span><span class="kw">mean</span>(<span class="dt">na.rm=</span><span class="ot">TRUE</span>)<span class="op">$</span>mat
  forecast_mat[<span class="kw">is.na</span>(forecast_mat)] &lt;-<span class="st"> </span><span class="dv">0</span>
  
  <span class="co"># Evaluate Performance</span>
  MAE &lt;-<span class="st"> </span><span class="kw">MAE</span>(forecast_mat, testing_inc)
  MSE &lt;-<span class="st"> </span><span class="kw">MSE</span>(forecast_mat, testing_inc)
  MAPE &lt;-<span class="st"> </span><span class="kw">MAPE</span>(forecast_mat, testing_inc)
  RMSE &lt;-<span class="st"> </span><span class="kw">RMSE</span>(forecast_mat, testing_inc)
  <span class="kw">return</span>(<span class="kw">c</span>(MAE,MSE,MAPE,RMSE))
}

gam_eval &lt;-<span class="st"> </span><span class="kw">evaluate</span>(forecast_gam)
sarimaTD_eval &lt;-<span class="st"> </span><span class="kw">evaluate</span>(forecast_sarimaTD)
sarima_eval &lt;-<span class="st"> </span><span class="kw">evaluate</span>(forecast_sarima)</code></pre></div>
Then, a final Table is made with all of the metrics in a grid format:
<table class="table table-striped" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
sarimaTD
</th>
<th style="text-align:right;">
SARIMA
</th>
<th style="text-align:right;">
GAM
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
MAE
</td>
<td style="text-align:right;">
0.4010836
</td>
<td style="text-align:right;">
1.612160
</td>
<td style="text-align:right;">
1.040956
</td>
</tr>
<tr>
<td style="text-align:left;">
MSE
</td>
<td style="text-align:right;">
0.5225570
</td>
<td style="text-align:right;">
4.752885
</td>
<td style="text-align:right;">
2.247290
</td>
</tr>
<tr>
<td style="text-align:left;">
MAPE
</td>
<td style="text-align:right;">
16.9582409
</td>
<td style="text-align:right;">
70.654734
</td>
<td style="text-align:right;">
50.057026
</td>
</tr>
<tr>
<td style="text-align:left;">
RMSE
</td>
<td style="text-align:right;">
0.7228811
</td>
<td style="text-align:right;">
2.180111
</td>
<td style="text-align:right;">
1.499096
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="creating-your-own-model-sarimatd-1" class="section level1">
<h1><strong>Creating your own Model</strong> SARIMATD</h1>
<div id="creating-your-own-model" class="section level3">
<h3>Creating your Own Model</h3>
<p>This Tutorial will demonstrate how to create a basic model with ForecastFramework. Models are created with R Object-Oriented programming, or the <a href="https://cran.r-project.org/web/packages/R6/vignettes/Introduction.html">R6 package</a>. It is essential to have a basic understanding of the structure of R6 Objects, before creating a ForecastFramework package. In this tutorial, the SARIMATD model will be created step-by-step.</p>
</div>
<div id="sarimatd" class="section level3">
<h3>SARIMATD</h3>
<p>SARIMATD is a model created by Evan Ray of the Reich Lab. SARIMATD uses set of wrapper functions around the forecast package to simplify estimation of and prediction from SARIMA models.</p>
<p>Basic Steps of the Model:</p>
<ol style="list-style-type: decimal">
<li>Incidence data are transformed to approximate normality</li>
<li>Seasonal differencing is performed</li>
<li>Transformed data are passed to <code>forecast::auto.arima</code> for model selection and estimation simulate trajectories of future incidence</li>
</ol>
</div>
<div id="building-the-sarimatd-model" class="section level3">
<h3>Building the SARIMATD Model</h3>
<div id="start-with-an-empty-model" class="section level4">
<h4>1. Start with an Empty Model</h4>
<p>ForecastFramework models all have the same basic structure:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">R6Class</span>(
  <span class="dt">inherit =</span> ContestModel, <span class="co"># or AggregateModel</span>
  <span class="dt">private =</span> <span class="kw">list</span>(
    <span class="co">#&#39; @method private section is for aspects we do not want the user to access directly</span>
  ),
  <span class="dt">public =</span> <span class="kw">list</span>(
    <span class="co">#&#39; @method fit_ Get the model ready to predict</span>
    <span class="co">#&#39; @param data The data to fit the model to.</span>
    <span class="dt">fit =</span> <span class="cf">function</span>(data){
      ...
    },
    <span class="co">#&#39; @method forecast Predict some number of time steps into the future.</span>
    <span class="co">#&#39; @param newdata The data to forecast from</span>
    <span class="co">#&#39; @param steps The number of timesteps into the future to predict.</span>
    <span class="dt">forecast =</span> <span class="cf">function</span>(newdata,steps){
      ...
    },
    <span class="co">#&#39; @method initialize Create a new instance of this class. </span>
    <span class="dt">initialize =</span> <span class="cf">function</span>(){
      ...
    },
    <span class="co">#&#39; @method predict predict using the model.</span>
    <span class="co">#&#39; @param newdata Predict using the model.</span>
    <span class="dt">predict =</span> <span class="cf">function</span>(newdata){
      ...
    },
  )
)</code></pre></div>
</div>
<div id="define-your-fit-and-forecast-functions" class="section level4">
<h4>2. Define your <code>fit()</code> and <code>forecast()</code> functions</h4>
<p>The easiest way to incorporate a model into ForecastFramework is to pre-define your fit and forecast functions in a separate package, or use a separate package like the <code>forecast</code> package. The <a href="https://github.com/reichlab/sarimaTD">SARMATD package</a> is hosted on Github and available for download with CRAN.</p>
<p>The SARIMATD fit function is as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @param y a univariate time series or numeric vector.</span>
<span class="co">#&#39; @param ts_frequency frequency of time series.  Must be provided if y is not</span>
<span class="co">#&#39;   of class &quot;ts&quot;.  See the help for stats::ts for more.</span>
<span class="co">#&#39; @param transformation character specifying transformation type:</span>
<span class="co">#&#39;   &quot;box-cox&quot;, &quot;log&quot;, &quot;forecast-box-cox&quot;, or &quot;none&quot;.  See details for more.</span>
<span class="co">#&#39; @param seasonal_difference boolean; take a seasonal difference before passing</span>
<span class="co">#&#39;   to auto.arima?</span>
<span class="co">#&#39; @param auto.arima_d order of first differencing argument to auto.arima.</span>
<span class="co">#&#39; @param auto.arima_D order of seasonal differencing argument to auto.arima.</span>
<span class="kw">fit_sarima</span>(
          y,
          ts_frequency,
          <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
          <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>,
          <span class="dt">d =</span> <span class="ot">NA</span>,
          <span class="dt">D =</span> <span class="ot">NA</span>)</code></pre></div>
<p>The SARIMATD forecast function is as follows (note that SARIMATD is a simulated forecast):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @param object a sarima fit of class &quot;sarima_td&quot;, as returned by fit_sarima</span>
<span class="co">#&#39; @param nsim number of sample trajectories to simulate</span>
<span class="co">#&#39; @param seed either `NULL` or an integer that will be used in a call to</span>
<span class="co">#&#39;   `set.seed` before simulating the response vectors.  If set, the value is</span>
<span class="co">#&#39;   saved as the &quot;seed&quot; attribute of the returned value.  The default, `Null`,</span>
<span class="co">#&#39;   will not change the random generator state, and return `.Random.seed`</span>
<span class="co">#&#39;   as the &quot;seed&quot; attribute</span>
<span class="co">#&#39; @param newdata new data to simulate forward from</span>
<span class="co">#&#39; @param h number of time steps forwards to simulate</span>
<span class="co">#&#39;</span>
<span class="co">#&#39; @return an nsim by h matrix with simulated values</span>
<span class="kw">simulate.sarimaTD</span>(
                  object,
                  <span class="dt">nsim =</span> <span class="dv">1</span>,
                  <span class="dt">seed =</span> <span class="ot">NULL</span>,
                  newdata,
                  <span class="dt">h =</span> <span class="dv">1</span>)</code></pre></div>
</div>
<div id="update-the-r6-private-section" class="section level4">
<h4>3. Update the R6 Private Section</h4>
<p>This section of the Model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> private =<span class="st"> </span><span class="kw">list</span>(
    <span class="co">#&#39; @method private section is for aspects we do not want the user to access directly</span>
  ),</code></pre></div>
<p>Will become:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  private =<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">.data =</span> <span class="ot">NULL</span>,        ## every model should have this
    <span class="dt">.models =</span> <span class="kw">list</span>(),    ## specific to models that are fit separately for each location
    <span class="dt">.nsim =</span> <span class="dv">1000</span>,         ## models that are simulating forecasts need this
    <span class="dt">.lambda =</span> <span class="kw">list</span>(),    ## specific to ARIMA models
    <span class="dt">.period =</span> <span class="kw">integer</span>(<span class="dv">0</span>) ## specific to SARIMA models
  ),</code></pre></div>
</div>
<div id="update-the-fit-method" class="section level4">
<h4>4. Update the fit Method</h4>
<p>Upload IncidenceMatrix to Fit function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> fit =<span class="st"> </span><span class="cf">function</span>(data) {
      ## All fit functions should have this, it helps with debugging
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
      
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
 }</code></pre></div>
<p>Cycle though each province and use the <code>fit_sarima()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> fit =<span class="st"> </span><span class="cf">function</span>(data) {
      ## All fit functions should have this, it helps with debugging
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
    
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
      ## for each location/row
      <span class="cf">for</span> (row_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>private<span class="op">$</span>.data<span class="op">$</span>nrow) {
        ### need to create a y vector with incidence at time t
        y &lt;-<span class="st"> </span>private<span class="op">$</span>.data<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> row_idx, <span class="dt">mutate =</span> <span class="ot">FALSE</span>)
        
        ## private$.models[[row_idx]] &lt;- something
        y_ts &lt;-<span class="st"> </span><span class="kw">ts</span>(<span class="kw">as.vector</span>(y<span class="op">$</span>mat), <span class="dt">frequency =</span> private<span class="op">$</span>.period)
        private<span class="op">$</span>.lambda[[row_idx]] &lt;-<span class="st"> </span><span class="kw">BoxCox.lambda</span>(y_ts)
        private<span class="op">$</span>.models[[row_idx]] &lt;-<span class="st"> </span><span class="kw">fit_sarima</span>(<span class="dt">y =</span> y_ts,
                                                 <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
                                                 <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>)
      }
 }</code></pre></div>
</div>
<div id="update-the-forecast-method" class="section level4">
<h4>4. Update the forecast Method</h4>
<p>Using the pre-defined equation <code>simulate.sarimaTD()</code> for the forecast method. <code>nmodels</code>, <code>sim_forecasts</code> and <code>dimnames(simforecasts)</code> are all variables needed to define a simulated forecast in ForecastFramework.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    forecast =<span class="st"> </span><span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
    }</code></pre></div>
<p>Now, the Provinces are iterated through and simulated with the <code>simulate.sarimaTD()</code>function (called as just <code>simulate()</code>). Then, there are a couple of matrix transformations to input the simulated matrix into the <code>SimulatedIncidenceMatrix()</code> Object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    forecast =<span class="st"> </span><span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
      ## iterate through each province and forecast with simulate.satimaTD
      <span class="cf">for</span>(model_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(private<span class="op">$</span>.models)) {
          tmp_arima &lt;-<span class="st">  </span><span class="kw">simulate</span>(<span class="dt">object =</span> private<span class="op">$</span>.models[[model_idx]],
                                 <span class="dt">nsim =</span> private<span class="op">$</span>.nsim,
                                 <span class="dt">seed =</span> <span class="dv">1</span>,
                                 <span class="dt">newdata =</span> <span class="kw">as.vector</span>(newdata<span class="op">$</span>mat[model_idx,]),
                                 <span class="dt">h =</span> steps
                                )
          ## transpose simulate() output to be consistent with ForecastFramework
          tmp_arima &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_arima)
          sim_forecasts[model_idx, , ] &lt;-<span class="st"> </span>tmp_arima
      }
      private<span class="op">$</span>output &lt;-<span class="st"> </span>SimulatedIncidenceMatrix<span class="op">$</span><span class="kw">new</span>(sim_forecasts)
      <span class="kw">return</span>(IncidenceForecast<span class="op">$</span><span class="kw">new</span>(private<span class="op">$</span>output, <span class="dt">forecastTimes =</span> <span class="kw">rep</span>(<span class="ot">TRUE</span>, steps)))
    }</code></pre></div>
</div>
<div id="update-the-initialize-method" class="section level4">
<h4>5. Update the initialize Method</h4>
<p>The initialize method is to initialize inputs. In this case, one input that needs initialization is the period (number of biweeks).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">initialize =<span class="st"> </span><span class="cf">function</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim=</span><span class="dv">1000</span>) { 
      ## this code is run during SARIMAModel$new()
      ## need to store these arguments within the model object
      private<span class="op">$</span>.nsim &lt;-<span class="st"> </span>nsim
      private<span class="op">$</span>.period &lt;-<span class="st"> </span>period
    },</code></pre></div>
</div>
<div id="update-the-active-section" class="section level4">
<h4>6. Update the active section</h4>
<p>This section determines what users can change in the model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">active =<span class="st"> </span><span class="kw">list</span>(
    ## This list determines how you can access pieces of your model object
    <span class="dt">data =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the data is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.data)
    },
    <span class="dt">models =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the models is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.models)
    },
    <span class="dt">nsim =</span> <span class="cf">function</span>(value) {
      ## use this form when you want to be able to change this parameter
      private<span class="op">$</span><span class="kw">defaultActive</span>(<span class="dt">type=</span><span class="st">&quot;private&quot;</span>, <span class="st">&quot;.nsim&quot;</span>, <span class="dt">val=</span>value)
    },
    <span class="dt">lambda =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to lambda is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.lambda)
    },
    <span class="dt">period =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the model period is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.period)
    }
  )</code></pre></div>
</div>
<div id="putting-everything-together" class="section level4">
<h4>7. Putting everything Together</h4>
<p>All of the previous sections and methods are put together as the R6 Object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(R6)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(sarimaTD)

<span class="co"># SARIMATDModel Description:</span>
<span class="co"># Implementation of the sarimaTD model created by Evan Ray</span>
<span class="co"># More information about sarimaTD in https://github.com/reichlab/sarimaTD </span>
<span class="co"># Integrated into ForecastFramework by: Katie House, 6/22/2018</span>

SARIMATD1Model &lt;-<span class="st"> </span><span class="kw">R6Class</span>(
  <span class="dt">inherit =</span> ContestModel,
  <span class="dt">private =</span> <span class="kw">list</span>(
    <span class="dt">.data =</span> <span class="ot">NULL</span>,        ## every model should have this
    <span class="dt">.models =</span> <span class="kw">list</span>(),    ## specific to models that are fit separately for each location
    <span class="dt">.nsim =</span> <span class="dv">1000</span>,        ## models that are simulating forecasts need this
    <span class="dt">.period =</span> <span class="kw">integer</span>(<span class="dv">0</span>) ## specific to SARIMA models
  ),
  <span class="dt">public =</span> <span class="kw">list</span>(
    ## data will be MatrixData
    <span class="dt">fit =</span> <span class="cf">function</span>(data) {
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
      ## for each location/row
      <span class="cf">for</span> (row_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>private<span class="op">$</span>.data<span class="op">$</span>nrow) {
        ### need to create a y vector with incidence at time t
        y &lt;-<span class="st"> </span>private<span class="op">$</span>.data<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> row_idx, <span class="dt">mutate =</span> <span class="ot">FALSE</span>)
        
        ## convert y vector to time series data type
        y_ts &lt;-<span class="st"> </span><span class="kw">ts</span>(<span class="kw">as.vector</span>(y<span class="op">$</span>mat), <span class="dt">frequency =</span> private<span class="op">$</span>.period)
        
        ## fit sarimaTD with &#39;fit_sarima()&#39; from sarimaTD package
        ## fit_sarima() performs box-cox transformation and seasonal differencing
        private<span class="op">$</span>.models[[row_idx]] &lt;-<span class="st"> </span><span class="kw">fit_sarima</span>(<span class="dt">y =</span> y_ts,
                                                 <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
                                                 <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>)
      }
    },
    <span class="dt">forecast =</span> <span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
      ## iterate through each province and forecast with simulate.satimaTD
      <span class="cf">for</span>(model_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(private<span class="op">$</span>.models)) {
          tmp_arima &lt;-<span class="st">  </span><span class="kw">simulate</span>(<span class="dt">object =</span> private<span class="op">$</span>.models[[model_idx]],
                                 <span class="dt">nsim =</span> private<span class="op">$</span>.nsim,
                                 <span class="dt">seed =</span> <span class="dv">1</span>,
                                 <span class="dt">newdata =</span> <span class="kw">as.vector</span>(newdata<span class="op">$</span>mat[model_idx,]),
                                 <span class="dt">h =</span> steps
                                )
          ## transpose simulate() output to be consistent with ForecastFramework
          tmp_arima &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_arima)
          sim_forecasts[model_idx, , ] &lt;-<span class="st"> </span>tmp_arima
      }
      private<span class="op">$</span>output &lt;-<span class="st"> </span>SimulatedIncidenceMatrix<span class="op">$</span><span class="kw">new</span>(sim_forecasts)
      <span class="kw">return</span>(IncidenceForecast<span class="op">$</span><span class="kw">new</span>(private<span class="op">$</span>output, <span class="dt">forecastTimes =</span> <span class="kw">rep</span>(<span class="ot">TRUE</span>, steps)))
    },
    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim=</span><span class="dv">1000</span>) { 
      ## this code is run during SARIMAModel$new()
      ## need to store these arguments within the model object
      private<span class="op">$</span>.nsim &lt;-<span class="st"> </span>nsim
      private<span class="op">$</span>.period &lt;-<span class="st"> </span>period
    },
    <span class="dt">predict =</span> <span class="cf">function</span>(newdata) {
      <span class="kw">stop</span>(<span class="st">&quot;predict method has not been written.&quot;</span>)
    }
  ),
  <span class="dt">active =</span> <span class="kw">list</span>(
    ## This list determines how you can access pieces of your model object
    <span class="dt">data =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the data is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.data)
    },
    <span class="dt">models =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the models is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.models)
    },
    <span class="dt">nsim =</span> <span class="cf">function</span>(value) {
      ## use this form when you want to be able to change this parameter
      private<span class="op">$</span><span class="kw">defaultActive</span>(<span class="dt">type=</span><span class="st">&quot;private&quot;</span>, <span class="st">&quot;.nsim&quot;</span>, <span class="dt">val=</span>value)
    },
    <span class="dt">period =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the model period is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.period)
    }
  )
)</code></pre></div>
</div>
<div id="testing-the-new-model" class="section level4">
<h4>8. Testing the New Model</h4>
<p>Lets now test the model on the same biweek counts as the SARIMA demo. The output is a forecasted case count for 26 biweeks.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># training data for province 10, years 2006 - 2012 </span>
<span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(R6)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(cdcfluview)

<span class="co"># Source R6 Files</span>
<span class="kw">library</span>(RCurl)

<span class="co"># Function of Source Github Models</span>
source_github &lt;-<span class="st"> </span><span class="cf">function</span>(u) {
  script &lt;-<span class="st"> </span><span class="kw">getURL</span>(u, <span class="dt">ssl.verifypeer =</span> <span class="ot">FALSE</span>)
  <span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> script),<span class="dt">envir=</span>.GlobalEnv)
}  
<span class="co"># Source R6 Files</span>
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/ContestModel.R&#39;</span>)
<span class="kw">source_github</span>(<span class="st">&#39;https://raw.githubusercontent.com/reichlab/forecast-framework-demos/master/models/SARIMATD1Model.R&#39;</span>)

<span class="co"># Preprocess data to Inc Matrix</span>
data2 &lt;-<span class="st"> </span><span class="kw">ilinet</span>(<span class="dt">region =</span> <span class="st">&quot;National&quot;</span>)
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>( week <span class="op">!=</span><span class="st"> </span><span class="dv">53</span>)
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2009</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">          </span>year <span class="op">&lt;</span><span class="st"> </span><span class="dv">2018</span> <span class="op">&amp;</span><span class="st"> </span>
<span class="st">          </span><span class="op">!</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;</span><span class="st"> </span><span class="dv">18</span>))
data2 &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;week&#39;</span>,<span class="st">&#39;weighted_ili&#39;</span>, <span class="st">&#39;week_start&#39;</span>)

preprocess_inc &lt;-<span class="st"> </span><span class="cf">function</span>(dat){
  dat<span class="op">$</span>time.in.year =<span class="st"> </span>dat<span class="op">$</span>week
  dat<span class="op">$</span>t =<span class="st"> </span>dat<span class="op">$</span>year <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>week<span class="op">/</span><span class="dv">52</span>
  inc =<span class="st"> </span>ObservationList<span class="op">$</span><span class="kw">new</span>(dat)
  inc<span class="op">$</span><span class="kw">formArray</span>(<span class="st">&#39;region&#39;</span>,<span class="st">&#39;t&#39;</span>,<span class="dt">val=</span><span class="st">&#39;weighted_ili&#39;</span>,
                <span class="dt">dimData =</span> <span class="kw">list</span>(<span class="ot">NULL</span>,<span class="kw">list</span>(<span class="st">&#39;week&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;time.in.year&#39;</span>,<span class="st">&#39;t&#39;</span>)),
                <span class="dt">metaData =</span> <span class="kw">list</span>(<span class="dt">t.step =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">52</span>,<span class="dt">max.year.time =</span> <span class="dv">52</span>))
  <span class="kw">return</span>(inc)
}
training_data &lt;-<span class="st"> </span>data2 <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>( <span class="op">!</span><span class="st"> </span>((year <span class="op">==</span><span class="st"> </span><span class="dv">2016</span> <span class="op">&amp;</span><span class="st"> </span>week <span class="op">&gt;=</span><span class="st"> </span><span class="dv">19</span>)<span class="op">|</span><span class="st"> </span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2017</span> ) ))
training_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(training_data)

<span class="co"># Create new SARIMATD model</span>
nsim &lt;-<span class="st"> </span><span class="dv">10</span> <span class="co"># Number of SARIMA simulations </span>
sarimaTD_model &lt;-<span class="st"> </span>SARIMATD1Model<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">52</span>, <span class="dt">nsim =</span> nsim)

<span class="co"># Fit SARIMATD model</span>
sarimaTD_model<span class="op">$</span><span class="kw">fit</span>(training_inc)

<span class="co"># Forecast SARIMATD Model</span>
steps &lt;-<span class="st"> </span><span class="dv">52</span> <span class="co"># forecast ahead 26 biweeks</span>
forecast_X &lt;-<span class="st"> </span>sarimaTD_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">steps =</span> steps)

<span class="kw">print</span>(forecast_X<span class="op">$</span>data<span class="op">$</span>mat)</code></pre></div>
<pre><code>##                 1        2        3        4        5        6        7
## National 1.494988 1.434023 1.305924 1.377093 1.277542 1.118989 1.107131
##                 8        9        10       11       12        13        14
## National 1.154718 1.075546 0.9737291 1.012862 0.968587 0.9295113 0.7956496
##                 15        16        17       18       19       20       21
## National 0.8622301 0.8591591 0.9388838 1.078237 1.289133 1.398952 1.492972
##               22       23       24       25      26       27       28
## National 1.60926 1.751339 1.542025 1.653691 1.66884 1.773896 1.632859
##                29       30       31       32       33       34       35
## National 1.857147 2.038057 2.382388 2.746086 3.745335 4.282143 2.835912
##                36       37       38       39       40       41       42
## National 2.686989 2.657029 2.691704 2.983318 3.318447 3.182371 2.847058
##                43       44       45       46       47       48       49
## National 3.019881 3.161179 2.587937 2.261168 2.166532 2.030118 1.869631
##                50       51       52
## National 1.842289 1.811737 1.579724</code></pre>
</div>
</div>
</div>

    </div>
    <div class="col-xs-2">
        </div>
  </div>
  </div>
  </div>
  <div class="row">
    </div>
  </div>

<script>
$(document).ready(function () {
  // add bootstrap table styles to pandoc tables
  $('tr.header').parent('thead').parent('table').addClass('table table-striped table-hover');

    var images = $('.pages img');
  images.filter(function() {
      if ($(this).parent().attr("class") == "figure") {
          return(false)
      } else {
          return(true);
      }
  }).wrap("<div class='figure'></div>");
  images.addClass("image-thumb").wrap("<div class='panel-body'></div>");
  $('.figure p.caption').wrap("<div class='panel-footer'></div>");
  $('.figure').addClass('panel panel-default');
  
    $('.pages img')
 	  .addClass("image-lb");
  $('.pages').magnificPopup({
	      type:'image',
	      closeOnContentClick: false,
	      delegate: 'img',
	      gallery: {enabled: false },
          removalDelay: 500,
          callbacks: {
              beforeOpen: function() {
                // just a hack that adds mfp-anim class to markup
                this.st.image.markup = this.st.image.markup.replace('mfp-figure', 'mfp-figure mfp-with-anim');
              }
          },
          mainClass: 'mfp-move-from-top',
	      image: {
	        verticalFit: true,
            titleSrc: 'alt'
	      }
 	    });
 	
    window.page = window.location.hash;
    if (window.page != "") {
      $(".menu").find("li[data-target=" + window.page + "]").trigger("click");
    }

    /* init material bootstrap js */
    $.material.init();
});
</script>




<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
