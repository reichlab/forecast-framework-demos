<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="ForecastFramework Demo" />


<title></title>
<!-- Material Design fonts -->
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<script src="index_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="index_files/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet" />
<script src="index_files/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="index_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<script src="index_files/navigation-1.1/tabsets.js"></script>
<script src="index_files/navigation-1.1/codefolding.js"></script>
<link href="index_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
<script src="index_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
<link href="index_files/bootstrap_material-0.1/bootstrap-material-design.min.css" rel="stylesheet" />
<link href="index_files/bootstrap_material-0.1/ripples.min.css" rel="stylesheet" />
<script src="index_files/bootstrap_material-0.1/material.min.js"></script>
<script src="index_files/bootstrap_material-0.1/ripples.min.js"></script>
<link href="index_files/material-0.1/material.css" rel="stylesheet" />
<script src="index_files/material-0.1/material.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; background-color: #f8f8f8; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
pre, code { background-color: #f8f8f8; }
code > span.kw { color: #204a87; font-weight: bold; } /* Keyword */
code > span.dt { color: #204a87; } /* DataType */
code > span.dv { color: #0000cf; } /* DecVal */
code > span.bn { color: #0000cf; } /* BaseN */
code > span.fl { color: #0000cf; } /* Float */
code > span.ch { color: #4e9a06; } /* Char */
code > span.st { color: #4e9a06; } /* String */
code > span.co { color: #8f5902; font-style: italic; } /* Comment */
code > span.ot { color: #8f5902; } /* Other */
code > span.al { color: #ef2929; } /* Alert */
code > span.fu { color: #000000; } /* Function */
code > span.er { color: #a40000; font-weight: bold; } /* Error */
code > span.wa { color: #8f5902; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #000000; } /* Constant */
code > span.sc { color: #000000; } /* SpecialChar */
code > span.vs { color: #4e9a06; } /* VerbatimString */
code > span.ss { color: #4e9a06; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #000000; } /* Variable */
code > span.cf { color: #204a87; font-weight: bold; } /* ControlFlow */
code > span.op { color: #ce5c00; font-weight: bold; } /* Operator */
code > span.pp { color: #8f5902; font-style: italic; } /* Preprocessor */
code > span.ex { } /* Extension */
code > span.at { color: #c4a000; } /* Attribute */
code > span.do { color: #8f5902; font-weight: bold; font-style: italic; } /* Documentation */
code > span.an { color: #8f5902; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #8f5902; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #8f5902; font-weight: bold; font-style: italic; } /* Information */
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->

</head>

<body>

<div class="header-panel shadow z-2">
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-3">
        <div id="header">
    <h1 class="title"><img src="images/logo.png" style="width:100px;"></h1>
                <h4 class="author"><em>ForecastFramework Demo</em></h4>
                </div>
    </div>
</div>
</div>
</div>


<div class="container-fluid main-container">
    <div class="row">
      <nav class="col-xs-3 menu" id="toc">
        <ul>
        <li><a href="#about-forecastframework"><strong>About</strong> ForecastFramework</a></li>
        <li><a href="#getting-started"><strong>Getting Started</strong></a></li>
        <li><a href="#the-data-1"><strong>The Data</strong></a></li>
        <li><a href="#defining-inputs-incidence-matrix-1"><strong>Defining Inputs</strong>: Incidence Matrix</a></li>
        <li><a href="#fitting-and-forecasting-sarima"><strong>Fitting and Forecasting</strong>: SARIMA</a></li>
        <li><a href="#evaluating-complex-models-sarimatd-vs-gam"><strong>Evaluating Complex Models</strong>: SARIMATD vs GAM</a></li>
        <li><a href="#creating-your-own-model-sarimatd-1"><strong>Creating your own Model</strong>: SARIMATD</a></li>
        </ul>
      </nav>
     <div class="pages col-xs-9">
     <div class="row">
       <div class="col-xs-10">



<div id="about-forecastframework" class="section level1">
<h1><strong>About</strong> ForecastFramework</h1>
<div id="purpose" class="section level3">
<h3>Purpose</h3>
<p>ForecastFramework is an object-oriented R package that standardizes forecasting models. The package uses the <a href="https://www.r-project.org/nosvn/pandoc/R6.html">R6 class implementation</a> to design an object-oriented framework for building forecasting models for spatial time-series data. The central goals of the ForecastFramework package are to enable <strong>rapid model development</strong> while <strong>standardizing and simplifying implementation</strong> and <strong>performance evaluation</strong>.</p>
</div>
<div id="usage" class="section level3">
<h3>Usage</h3>
<p>ForecastFramework is the primary modeling tool used at the <a href="http://reichlab.io/">Reich Lab</a> at the University of Massachusetts Amherst. Specifically, it is the modeling format used in the Predict the District Challenge.</p>
<p>The following diagram illustrates the flow of a ForecastFramework Modeling process:</p>
<p><img src="images/ff_diagram_overview.png" class="medium"></p>
</div>
<div id="creation" class="section level3">
<h3>Creation</h3>
<p>ForecastFramework was created by Joshua Kaminsky of the <a href="http://www.iddynamics.jhsph.edu/">Infectious Disease Dynamics Group</a> at Johns Hopkins University.</p>
</div>
</div>
<div id="getting-started" class="section level1">
<h1><strong>Getting Started</strong></h1>
<div id="installation" class="section level3">
<h3>Installation</h3>
<p>ForecastFramework is an open source R package hosted on <a href="https://cran.r-project.org/web/packages/ForecastFramework/index.html">CRAN</a> and <a href="https://github.com/HopkinsIDD/ForecastFramework">Github</a>.</p>
<p>To install this package, either run the following commands in your <a href="https://www.rstudio.com/">Rstudio</a> console:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">install.packages</span>(<span class="st">&#39;ForecastFramework&#39;</span>)</code></pre></div>
<p>Or:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(devtools)
devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&#39;HopkinsIDD/ForecastFramework&#39;</span>)</code></pre></div>
</div>
<div id="the-forecastframework-pipeline" class="section level3">
<h3>The ForecastFramework Pipeline</h3>
<p>Before creating your own ForecastFramework models, letâ€™s dive deeper into the forecasting process with ForecastFramework.</p>
<p>The ForecastFramework model is comprised of three parts: the data, the model, and the prediction. <img src="images/ff_diagram_overview.png" class="medium"></p>
<p>These three areas of ForecastFramework make up the ForecastFramework pipeline: preprocessing, defining inputs, fitting, and predicting: <img src="images/ff_pipeline.png" class="large"></p>
<p>Each of the subsequent vignettes looks into a part of this process. However, the preprocesing stage will be included in the Defining Inputs Vignette.</p>
</div>
<div id="vignette-overview" class="section level3">
<h3>Vignette Overview:</h3>
<ul>
<li><h4 id="the-data"><code>The Data</code></h4>
This section will examines the raw data used in the ForecastFramework models ahead.</li>
<li><h4 id="defining-inputs-incidence-matrix"><code>Defining Inputs: Incidence Matrix</code></h4>
(<em>Beginner Section</em>) This section will define what an Incidence Matrix is, show how to format your data to be used as an Incidence Matrix, and exemplify functions of Incidence Matrices.</li>
<li><h4 id="fitting-and-predicting-sarima"><code>Fitting and Predicting: SARIMA</code></h4>
(<em>Beginner Section</em>)This section will focus on fitting data to a SARIMA model with ForecastFramework.</li>
<li><h4 id="evaluating-complex-models-sarimatd-vs.-gam"><code>Evaluating Complex Models: SARIMATD vs. GAM</code></h4>
(<em>Intermediate Section</em>) This section will demonstrate evaluation metrics and techniques by comparing two complex models in ForecastFramework.</li>
<li><h4 id="creating-your-own-model-sarimatd"><code>Creating your own Model: SARIMATD</code></h4>
(<em>Advanced Section</em>) This section will demonstrate how to create your own model with ForecastFramework. NOTE: This section requires object-oriented programming knowledge.</li>
</ul>
</div>
</div>
<div id="the-data-1" class="section level1">
<h1><strong>The Data</strong></h1>
<div id="demo-data-dengue-fever-bangkok" class="section level3">
<h3>Demo Data: Dengue Fever Bangkok</h3>
<p>This demonstration uses Dengue Hemorrhagic Fever case count data from the Ministry of Public Health in Thailand. Normally, the data include all 76 provinces of Thailand. For simplicity, this demo only models Bangkok Metropolis (Province ID 10). Bangkok was chosen due to a lack on sparsity in the data.</p>
<div id="raw-data" class="section level4">
<h4>Raw Data</h4>
<p>These data include: <code>province</code>, <code>year</code>, <code>biweek</code>, <code>date_sick</code>, and <code>cases</code>. <code>cases</code> is the aggegate sum of Dengue Fever cases for that specific year and biweek.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;../data/province-biweek-counts.csv&#39;</span>)
<span class="kw">print</span>(<span class="kw">head</span>(dat))</code></pre></div>
<pre><code>##   province year biweek date_sick cases
## 1       10 2006      1  1/1/2006   265
## 2       10 2006      2 1/15/2006   162
## 3       10 2006      3 1/29/2006   211
## 4       10 2006      4 2/12/2006   113
## 5       10 2006      5 2/26/2006   165
## 6       10 2006      6 3/12/2006   146</code></pre>
</div>
<div id="time-series" class="section level4">
<h4>Time Series</h4>
<p>A time series of the raw data looks like the following: <img src="index_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="scope-of-this-demo" class="section level4">
<h4>Scope of this demo</h4>
<p>This demo will use these data to create a ForecastFramework model for year 2013!</p>
</div>
</div>
</div>
<div id="defining-inputs-incidence-matrix-1" class="section level1">
<h1><strong>Defining Inputs</strong>: Incidence Matrix</h1>
<div id="what-is-an-incidencematrix" class="section level3">
<h3>What is an IncidenceMatrix?</h3>
<p>ForecastFramework makes it easy to quickly manipulate forecasting data. To do this, create an object from a class called IncidenceMatrix. IncidenceMatrices are the stanard inputs for ForecastFramework models. This vignette describes how to create an IncidenceMatrix and some key fields and methods relating to their usage.</p>
</div>
<div id="incidencematrix-in-the-forecastframework-process" class="section level3">
<h3>IncidenceMatrix in the ForecastFramework Process</h3>
<p><img src="images/IncidenceMatrixDia.png" class="large"></p>
</div>
<div id="how-to-create-an-incidencematrix" class="section level3">
<h3>How to create an IncidenceMatrix</h3>
<ol style="list-style-type: decimal">
<li>Make sure you import <code>ForecastFramework</code> and <code>R6</code></li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(R6)
<span class="kw">library</span>(ForecastFramework)</code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Create a new matrix with your data</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_matrix &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>,<span class="dv">3</span>,<span class="dv">3</span>)
<span class="kw">print</span>(data_matrix)</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Create a new IncidenceMatrix object with your data</li>
</ol>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data_matrix)</code></pre></div>
</div>
<div id="list-incidencematrix-fields" class="section level3">
<h3>List IncidenceMatrix Fields</h3>
<p>The IncidenceMatrix class has several fields that can be helpful for data preprocessing.</p>
<ul>
<li><code>$mat</code> show data in matrix form</li>
<li><code>$nrow</code> number of rows</li>
<li><code>$ncol</code> number of columns</li>
<li><code>$colData</code> columns headers</li>
<li><code>$rowData</code> row names</li>
<li><code>$cellData</code> list of cell metadata</li>
<li><code>$cnames</code> names of matrix columns</li>
<li><code>$rnames</code> names of matrix rows</li>
<li><code>$metaData</code> any data not part of main matrix</li>
</ul>
</div>
<div id="methods" class="section level3">
<h3>Methods</h3>
<p>In object oriented programming, a â€˜methodâ€™ is a function for a class. In this case, the following methods are functions that are applied to IncidenceMatrix.</p>
<ul>
<li><code>$addColumns(n)</code> add <code>n</code> columns to matrix</li>
<li><code>$addRows(n)</code> add <code>n</code> rows to matrix</li>
<li><code>$diff(n)</code> difference between each column and lag <code>n</code> columns to the left</li>
<li><code>$lag(n)</code> lag each columns by <code>n</code></li>
<li><code>$head(x,y)</code> show <code>x</code> columns/rows from the top (<code>y</code>=1 for columns, 2 for rows)</li>
<li><code>$tail(x,y)</code> show <code>x</code> columns/rows from the bottom (<code>y</code>=1 for columns, 2 for rows)</li>
<li><code>$scale(functin(x){})</code> scale the matrix by some function</li>
<li><code>$subset(rows=x,cols=y)</code> take a subset of the matrix by <code>x</code> rows and <code>y</code> columns</li>
</ul>
</div>
<div id="field-examples" class="section level3">
<h3>Field Examples</h3>
<p>Letâ€™s apply some of the example functions from above to our <code>data_object</code>.</p>
<p><strong>$mat</strong> show data in matrix form:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>mat</code></pre></div>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9</code></pre>
<p></br><strong>$nrow</strong> number of rows in the matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>nrow</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p></br><strong>$ncol</strong> number of columns in the matrix:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>ncol</code></pre></div>
<pre><code>## [1] 3</code></pre>
<p></br><strong>$colData</strong> Edit or the column names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>colData &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="co"># Initialize how many columns headers</span>
data_object<span class="op">$</span>colData &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">c</span>(<span class="st">&quot;A&quot;</span>,<span class="st">&quot;B&quot;</span>,<span class="st">&quot;C&quot;</span>))
data_object<span class="op">$</span>colData</code></pre></div>
<pre><code>## [[1]]
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot;</code></pre>
<p></br><strong>$addColumns</strong> Edit or the column names:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span><span class="kw">addColumns</span>(<span class="dv">2</span>)
data_object<span class="op">$</span>colData</code></pre></div>
<pre><code>## [[1]]
## [1] &quot;A&quot; &quot;B&quot; &quot;C&quot; NA  NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">data_object<span class="op">$</span>mat</code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5]
## [1,]    1    4    7   NA   NA
## [2,]    2    5    8   NA   NA
## [3,]    3    6    9   NA   NA</code></pre>
</div>
</div>
<div id="fitting-and-forecasting-sarima" class="section level1">
<h1><strong>Fitting and Forecasting</strong>: SARIMA</h1>
<p>This demonstration investigate the usage of models with ForecastFramework. For more information on the SARIMA Model itself, check out: <a href="https://github.com/reichlab/thai-dengue-district-challenge/blob/master/doc/ff-intro.Rmd" class="uri">https://github.com/reichlab/thai-dengue-district-challenge/blob/master/doc/ff-intro.Rmd</a>.</p>
<div id="fitting-the-forecastframework-sarima-model" class="section level3">
<h3>Fitting the ForecastFramework SARIMA Model</h3>
<div id="import-packages" class="section level4">
<h4>1. Import packages</h4>
<p>First you must import all the required libraries. Note that ForecastFramework doesnâ€™t requre <code>dplyr</code> or <code>ggplot2</code>, but they will be used to make a figure at the end of the demo.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">require</span>(ForecastFramework)
<span class="kw">require</span>(R6)
<span class="kw">require</span>(forecast)
<span class="kw">require</span>(dplyr)
<span class="kw">require</span>(ggplot2)

<span class="co"># Source R6 Files</span>
<span class="kw">source</span>(<span class="st">&#39;../models/ContestModel.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&#39;../models/SARIMAModel.R&#39;</span>)</code></pre></div>
<p>Now it is time to fit your SARIMA Model! ForecastFramework makes this easy.</p>
</div>
<div id="create-new-sarima_model-class" class="section level4">
<h4>2. Create new sarima_model Class</h4>
<p>In this SARIMA model, simulation is used with <code>::forecast auto.arima()</code>. So we must define the number of simulations to use, <code>nsim</code>. We also need to define the seasonal periodicity of our data, or the <code>period</code> parameter. For Dengue forecasting, we know the periodicity is 26, because the data is biweekly. once we define these parameters, they can be passed into the <code>SARIMAModel()</code> class generator to create a new <code>sarima_model</code> class.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">nsim &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># Number of SARIMA simulations </span>
sarima_model &lt;-<span class="st"> </span>SARIMAModel<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim =</span> nsim)</code></pre></div>
</div>
<div id="import-dengue-data" class="section level4">
<h4>3. Import Dengue Data</h4>
<p>To import data from a local csv, use the <code>read.csv()</code> command. In this example, the <code>date_sick</code> field is imported as a wrong datatype, so it must be converted to a date value with a couple of transformations. Then, the data is stored as an <code>IncidenceMatrix()</code>. An incidence matrix represents spatial time-series data in a matrix with one row per location and one column per time. To do this, another series of transformations are made. IncidenceMatrix is the preferred input for ForecastFramework Models.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># training data for province 10, years 2006 - 2012 </span>
dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;../data/province-biweek-counts-training.csv&#39;</span>)
dat<span class="op">$</span>date_sick &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">strptime</span>(dat<span class="op">$</span>date_sick,<span class="st">&quot;%m/%d/%Y&quot;</span>)) <span class="co"># convert to date values</span>
inc &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(<span class="dv">1</span><span class="op">+</span>reshape2<span class="op">::</span><span class="kw">acast</span>(dat,province<span class="op">~</span>date_sick,<span class="dt">value.var=</span><span class="st">&#39;cases&#39;</span>))
<span class="kw">print</span>(inc<span class="op">$</span>mat[,<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>])</code></pre></div>
<pre><code>## 2006-01-01 2006-01-15 2006-01-29 2006-02-12 2006-02-26 2006-03-12 
##        266        163        212        114        166        147 
## 2006-03-26 2006-04-09 2006-04-23 2006-05-07 
##        138        118         75        407</code></pre>
<p>Letâ€™s look at a sample from the new IncidenceMatrix to view the IncidenceMatrixx Format:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">print</span>(inc<span class="op">$</span>mat[,<span class="dv">0</span><span class="op">:</span><span class="dv">10</span>])</code></pre></div>
<pre><code>## 2006-01-01 2006-01-15 2006-01-29 2006-02-12 2006-02-26 2006-03-12 
##        266        163        212        114        166        147 
## 2006-03-26 2006-04-09 2006-04-23 2006-05-07 
##        138        118         75        407</code></pre>
</div>
<div id="fit-the-model" class="section level4">
<h4>3. Fit the Model</h4>
<p>Typically, all the provinces in Thailand would be fit separately and have different forecasts. For the scope of this demo, we are only fitting and forecasting Province 10, or Bangkok Metropolis. The ForecastFramework SARIMA Model method requires the user to specify which province to model, in this case, we are modeling the first (and only) province in the dataset.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define how many provinces to model</span>
<span class="co"># this demo only has data for one province: Province 10</span>
prov_nums &lt;-<span class="st"> </span><span class="dv">1</span>
nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(prov_nums)
sarima_model<span class="op">$</span><span class="kw">fit</span>(inc<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> prov_nums, <span class="dt">mutate =</span> <span class="ot">FALSE</span>))</code></pre></div>
</div>
</div>
<div id="forecasting-with-the-forecastframework-sarima-model" class="section level3">
<h3>Forecasting with the ForecastFramework SARIMA Model</h3>
<div id="forecasting-sarima" class="section level4">
<h4>4. Forecasting SARIMA</h4>
<p>Before forecasting, you must specify how many periods ahead you would like to forecast. This is defined by the <code>steps</code> parameter. Then, you forecast with the <code>sarima_model$forecast()</code> method. This model will forecast one year into the future (26 biweeks).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># define how many provinces to model</span>
<span class="co"># this demo only has data for one province: Province 10</span>
steps &lt;-<span class="st"> </span><span class="dv">26</span> <span class="co"># forecast ahead 26 biweeks</span></code></pre></div>
<p>Then, use the built-in <code>$forecast()</code> function to create your forecasts. This creates a new R6 object with your forecasts and many other useful built-in functions. Be sure to check out the Evaluation section for usage of the Forecasting function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">forecast_X &lt;-<span class="st"> </span>sarima_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">steps =</span> steps)</code></pre></div>
</div>
</div>
<div id="plotting-the-output" class="section level3">
<h3>Plotting the Output</h3>
<div id="formatting-the-forecast-output" class="section level4">
<h4>5. Formatting the Forecast Output</h4>
<p>To view the new forecasting data in matrix form, execute the following command:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">forecast_X<span class="op">$</span>data<span class="op">$</span>mat</code></pre></div>
<pre><code>##          1        2        3        4        5        6        7        8
## 10 421.364 310.5878 328.1625 182.7838 110.1469 81.04734 61.05778 42.05863
##           9       10       11       12       13      14       15       16
## 10 176.6802 36.38489 109.4452 181.1747 293.9457 292.283 475.9351 304.6238
##          17       18       19       20       21       22       23       24
## 10 309.0357 526.8641 472.3367 449.8224 586.9356 641.5018 705.3736 816.1487
##          25       26
## 10 709.8933 640.0368</code></pre>
<p>Lets convert the forecast matrix to a dataframe in R for easy manipulation:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># converting predictions to a dataframe to use dplyr</span>
preds_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">as.table</span>(<span class="kw">t</span>(forecast_X<span class="op">$</span>data<span class="op">$</span>mat)))</code></pre></div>
<p>To include the <code>date_sick</code> in the <code>forecast_X$data$mat</code> output, map the forecast to its predicted dates is to create a new data frame with the data from the missing year. Then, we will combine the output in <code>forecast_X$data</code> with the correct biweek dates.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># converting predictions to a dataframe to use dplyr</span>
<span class="co"># import testing dataset which has 2013 data</span>
data_X &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;../data/province-biweek-counts-testing.csv&#39;</span>)
data_X<span class="op">$</span>date_sick &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">strptime</span>(data_X<span class="op">$</span>date_sick,<span class="st">&quot;%m/%d/%Y&quot;</span>)) <span class="co"># convert to date values</span>
preds_dates &lt;-<span class="st"> </span>data_X <span class="op">%&gt;%</span>
<span class="st">          </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2013</span>)
<span class="co"># add prediction dates to original forecast</span>
preds_df[[<span class="st">&quot;date_sick&quot;</span>]] &lt;-<span class="kw">as.Date</span>(preds_dates<span class="op">$</span>date_sick, <span class="dt">format =</span> <span class="st">&quot;%d-%m-%Y&quot;</span>)</code></pre></div>
<p>Now, we can add the forecast to the <code>preds_df</code>. Notice the <code>$median()</code> and <code>$quantile()</code> functions accompanied with <code>$mat</code> will produce matricies with the prediction medians and quantiles, respectively.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">preds_df &lt;-<span class="st"> </span>preds_df <span class="op">%&gt;%</span>
<span class="st">   </span><span class="kw">mutate</span>( 
      <span class="dt">pred_total_cases =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">median</span>()<span class="op">$</span>mat),
      <span class="dt">pred_95_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.025</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.975</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.05</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.95</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_lb =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.25</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_ub =</span> <span class="kw">as.vector</span>(forecast_X<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.75</span>)<span class="op">$</span>mat)
   )
<span class="kw">print</span>(<span class="kw">head</span>(preds_df,<span class="dv">5</span>)) <span class="co"># Print the first 5 rows</span></code></pre></div>
<pre><code>##   Var1 Var2     Freq  date_sick pred_total_cases pred_95_lb pred_95_ub
## 1    1   10 421.3640 2013-01-01         406.1991  231.80110   630.4926
## 2    2   10 310.5878 2013-01-15         310.6345  142.85480   542.0431
## 3    3   10 328.1625 2013-01-29         279.5906  106.25364   528.9722
## 4    4   10 182.7838 2013-02-12         263.7806   94.49549   508.6718
## 5    5   10 110.1469 2013-02-26         236.4479   78.85420   487.4473
##   pred_80_lb pred_80_ub pred_50_lb pred_50_ub
## 1  247.15698   599.0145   336.6342   478.5575
## 2  163.51989   507.0447   247.5443   388.6216
## 3  131.89279   478.8598   212.0853   357.4497
## 4  116.37470   473.6273   195.7696   347.5568
## 5   94.30415   453.8269   168.2205   322.1016</code></pre>
</div>
<div id="plot-the-forecast-output" class="section level4">
<h4>6. Plot the Forecast Output</h4>
<p>Finally, you are able to plot your SARIMA Forecast! Lets use <code>ggplot2</code> to create a cool plot. ### Bangkok Metropolis SARIMA Forecast <img src="index_files/figure-html/unnamed-chunk-31-1.png" width="960" /></p>
</div>
</div>
</div>
<div id="evaluating-complex-models-sarimatd-vs-gam" class="section level1">
<h1><strong>Evaluating Complex Models</strong>: SARIMATD vs GAM</h1>
<div id="evaluating-complex-models" class="section level3">
<h3>Evaluating Complex Models</h3>
<p>This Tutorial will demonstrate how to easily compare two models on ForecastFramework. One of the best advantages of ForecastFramework is the ability to evaluate many models at once with the same functions.</p>
<div id="preprocessing-data" class="section level4">
<h4>Preprocessing Data</h4>
<p>Import libraries and source models</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(R6)
<span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(ggplot2)
<span class="kw">library</span>(gridExtra)
<span class="kw">library</span>(knitr)

<span class="kw">source</span>(<span class="st">&#39;../models/GamModel.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&#39;../models/SARIMATD1Model.R&#39;</span>)
<span class="kw">source</span>(<span class="st">&#39;../models/ContestModel.R&#39;</span>)</code></pre></div>
<p>Upload data as dataframes and convert to training/testing data.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;../data/province-biweek-counts.csv&#39;</span>)
dat<span class="op">$</span>date_sick &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">strptime</span>(dat<span class="op">$</span>date_sick,<span class="st">&quot;%m/%d/%Y&quot;</span>)) <span class="co"># convert to date values</span>
training_data &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">!=</span><span class="st"> </span><span class="dv">2013</span>)
testing_data &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">==</span><span class="st"> </span><span class="dv">2013</span>)</code></pre></div>
<p>Preprocess both the training and testing dataframes. This function uses the <code>ObservationList$new()</code> ForecastFramework function to easily convert the dataframe to an incidence matrix. Note that <code>$formArray()</code> is the second step to complete the incidence matrix.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Convert Training and Testing data to incidence matrices</span>
<span class="co"># time.in.year is a requirement for the GAM model</span>
preprocess_inc &lt;-<span class="st"> </span><span class="cf">function</span>(dat){
  dat<span class="op">$</span>time.in.year =<span class="st"> </span>dat<span class="op">$</span>biweek
  dat<span class="op">$</span>t =<span class="st"> </span>dat<span class="op">$</span>year <span class="op">+</span><span class="st"> </span>dat<span class="op">$</span>biweek<span class="op">/</span><span class="dv">26</span>
  inc =<span class="st"> </span>ObservationList<span class="op">$</span><span class="kw">new</span>(dat)
  inc<span class="op">$</span><span class="kw">formArray</span>(<span class="st">&#39;province&#39;</span>,<span class="st">&#39;t&#39;</span>,<span class="dt">val=</span><span class="st">&#39;cases&#39;</span>,
                <span class="dt">dimData =</span> <span class="kw">list</span>(<span class="ot">NULL</span>,<span class="kw">list</span>(<span class="st">&#39;biweek&#39;</span>,<span class="st">&#39;year&#39;</span>,<span class="st">&#39;time.in.year&#39;</span>,<span class="st">&#39;t&#39;</span>)),
                <span class="dt">metaData =</span> <span class="kw">list</span>(<span class="dt">t.step =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">26</span>,<span class="dt">max.year.time =</span> <span class="dv">26</span>))
  <span class="kw">return</span>(inc)
}

<span class="co"># Preprocess Data and convert to Inc Mat</span>
training_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(training_data)
testing_inc &lt;-<span class="st"> </span><span class="kw">preprocess_inc</span>(testing_data)</code></pre></div>
</div>
<div id="defining-models" class="section level4">
<h4>Defining Models</h4>
<p>This demo will be evaluating the GAM and the <a href="https://github.com/reichlab/sarimaTD/blob/master/vignettes/sarimaTD.Rmd">sarimaTD</a> forecast models on Bangkok Metropolis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Defining the Models</span>
nsim &lt;-<span class="st"> </span><span class="dv">100</span> <span class="co"># Number of simulations </span>
prov_nums &lt;-<span class="st"> </span><span class="dv">1</span> <span class="co"># Number of Provinces</span>
sarima_model &lt;-<span class="st"> </span>SARIMATD1Model<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim =</span> nsim)
gam_model &lt;-<span class="st"> </span>GamModel<span class="op">$</span><span class="kw">new</span>(<span class="dt">numProvinces =</span> prov_nums,<span class="dt">nSims =</span> nsim)</code></pre></div>
</div>
<div id="fitting-models" class="section level4">
<h4>Fitting Models</h4>
<p>Each model is fit with the training data (excluding year 2013).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Fit the Models </span>
sarima_model<span class="op">$</span><span class="kw">fit</span>(training_inc)
gam_model<span class="op">$</span><span class="kw">fit</span>(training_inc)</code></pre></div>
</div>
<div id="forecasting-models" class="section level4">
<h4>Forecasting Models</h4>
<p>We are forecasting year 2013 (26 biweeks) into the future.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Forecasting the Models</span>
steps &lt;-<span class="st"> </span><span class="dv">26</span> <span class="co"># forecast ahead 26 biweeks</span>
forecast_gam &lt;-<span class="st"> </span>gam_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">step =</span> steps)
forecast_sarimaTD &lt;-<span class="st"> </span>sarima_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">step =</span> steps)</code></pre></div>
</div>
<div id="evaluating-the-models" class="section level4">
<h4>Evaluating the Models</h4>
<p>Now for the fun part! Which model performed better? This question is easy to answer with ForecastFramework Models.</p>
<div id="side-by-side-forecasting-timeseries" class="section level5">
<h5>Side-by-Side Forecasting Timeseries</h5>
<p>This function creates a time series visualization with the predicted median and quantiles displayed by a specific color. Notice <code>forecast$quantile(0.025)$mat</code> gives a matrix with a 2.5% quantile. Additionally, <code>forecast$median()$mat</code> gives the median forecast for that specific time period.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Function to create time series with Visualization</span>
visualize_model &lt;-<span class="st"> </span><span class="cf">function</span>(forecast, rib_color, main_color){
  data_X_3years &lt;-<span class="st"> </span>dat <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">filter</span>(year <span class="op">&gt;</span><span class="st"> </span><span class="dv">2011</span>)
  preds_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">as.table</span>(<span class="kw">t</span>(forecast<span class="op">$</span>data<span class="op">$</span>mat)))
  preds_df[[<span class="st">&quot;date_sick&quot;</span>]] &lt;-<span class="kw">as.Date</span>(testing_data<span class="op">$</span>date_sick, <span class="dt">format =</span> <span class="st">&quot;%d/%m/%Y&quot;</span>)
  preds_df &lt;-<span class="st"> </span>preds_df <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">mutate</span>( 
      <span class="dt">pred_total_cases =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">median</span>()<span class="op">$</span>mat),
      <span class="dt">pred_95_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.025</span>)<span class="op">$</span>mat),
      <span class="dt">pred_95_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.975</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.05</span>)<span class="op">$</span>mat),
      <span class="dt">pred_80_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.95</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_lb =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.25</span>)<span class="op">$</span>mat),
      <span class="dt">pred_50_ub =</span> <span class="kw">as.vector</span>(forecast<span class="op">$</span><span class="kw">quantile</span>(<span class="fl">0.75</span>)<span class="op">$</span>mat)
    )
  plot &lt;-<span class="st"> </span><span class="kw">ggplot</span>() <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date_sick, <span class="dt">ymin =</span> pred_95_lb, <span class="dt">ymax =</span> pred_95_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date_sick, <span class="dt">ymin =</span> pred_80_lb, <span class="dt">ymax =</span> pred_80_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_ribbon</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date_sick, <span class="dt">ymin =</span> pred_50_lb, <span class="dt">ymax =</span> pred_50_ub),
      <span class="dt">fill =</span> rib_color,
      <span class="dt">alpha =</span> <span class="fl">0.2</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(
      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date_sick, <span class="dt">y =</span> pred_total_cases),
      <span class="dt">color =</span> main_color,
      <span class="dt">size =</span> <span class="dv">1</span>,
      <span class="dt">data =</span> preds_df) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date_sick, <span class="dt">y =</span> cases),
              <span class="dt">size=</span><span class="fl">0.7</span>,
              <span class="dt">data =</span> data_X_3years) <span class="op">+</span>
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Number of Cases&quot;</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">coord_cartesian</span>(<span class="dt">ylim =</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="dv">1000</span>))
  <span class="kw">return</span>(plot)
}

<span class="co"># Create each plot</span>
plot1 &lt;-<span class="st"> </span><span class="kw">visualize_model</span>(forecast_sarimaTD, <span class="st">&quot;coral1&quot;</span>, <span class="st">&quot;red&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;SARIMATD&quot;</span>)
plot2 &lt;-<span class="st"> </span><span class="kw">visualize_model</span>(forecast_gam, <span class="st">&quot;cornflowerblue&quot;</span> , <span class="st">&quot;blue&quot;</span>)<span class="op">+</span><span class="st"> </span><span class="kw">ggtitle</span>(<span class="st">&quot;GAM&quot;</span>)

<span class="co"># Display side-by-side plots</span>
<span class="kw">grid.arrange</span>(plot1, plot2, <span class="dt">ncol=</span><span class="dv">2</span>)</code></pre></div>
<p><img src="index_files/figure-html/unnamed-chunk-38-1.png" width="1056" /></p>
</div>
<div id="common-evaluation-metrics" class="section level5">
<h5>Common Evaluation Metrics</h5>
<p>Calculating evaluation metrics is easy with ForecastFramework objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Mean Absolute Error</span>
MAE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_inc, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_inc<span class="op">$</span><span class="kw">mean</span>()<span class="op">$</span>mat
  abs_err &lt;-<span class="st"> </span><span class="kw">abs</span>(err)
  <span class="kw">return</span>(<span class="kw">mean</span>(abs_err))
}
<span class="co"># Mean Squared Error</span>
MSE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_inc, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_inc<span class="op">$</span><span class="kw">mean</span>()<span class="op">$</span>mat
  err_sq &lt;-<span class="st"> </span>err<span class="op">^</span><span class="dv">2</span>
  <span class="kw">return</span>(<span class="kw">mean</span>(err_sq))
}
<span class="co"># Mean Absolute Percentage Error</span>
MAPE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_inc, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_inc<span class="op">$</span><span class="kw">mean</span>()<span class="op">$</span>mat
  abs_err &lt;-<span class="st"> </span><span class="kw">abs</span>(err)
  abs_err_percent &lt;-<span class="st"> </span>abs_err<span class="op">/</span>test_inc<span class="op">$</span>mat
  <span class="kw">return</span>(<span class="kw">mean</span>(abs_err_percent)<span class="op">*</span><span class="dv">100</span>)
}
<span class="co"># Root Mean Squared Error</span>
RMSE &lt;-<span class="st"> </span><span class="cf">function</span>(forecast_inc, test_inc){
  err &lt;-<span class="st"> </span>test_inc<span class="op">$</span>mat<span class="op">-</span>forecast_inc<span class="op">$</span><span class="kw">mean</span>()<span class="op">$</span>mat
  err_sq &lt;-<span class="st"> </span>err<span class="op">^</span><span class="dv">2</span>
  mse &lt;-<span class="kw">mean</span>(err_sq)
  <span class="kw">return</span>(<span class="kw">sqrt</span>(mse))
}</code></pre></div>
<p>Each Model can be evaluated given the various functions:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Create Arrays with each Metric</span>
evaluate &lt;-<span class="st"> </span><span class="cf">function</span>(forecast){
  MAE &lt;-<span class="st"> </span><span class="kw">MAE</span>(forecast, testing_inc)
  MSE &lt;-<span class="st"> </span><span class="kw">MSE</span>(forecast, testing_inc)
  MAPE &lt;-<span class="st"> </span><span class="kw">MAPE</span>(forecast, testing_inc)
  RMSE &lt;-<span class="st"> </span><span class="kw">RMSE</span>(forecast, testing_inc)
  <span class="kw">return</span>(<span class="kw">c</span>(MAE,MSE,MAPE,RMSE))
}

gam_eval &lt;-<span class="st"> </span><span class="kw">evaluate</span>(forecast_gam)
sarimaTD_eval &lt;-<span class="st"> </span><span class="kw">evaluate</span>(forecast_sarimaTD)</code></pre></div>
<p>Then, a final Table is made with all of the metrics in a grid format:</p>
<table>
<caption>Model Evaluation Metrics</caption>
<thead>
<tr class="header">
<th></th>
<th align="right">GAM</th>
<th align="right">sarimaTD</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MAE</td>
<td align="right">339.2696</td>
<td align="right">68.21344</td>
</tr>
<tr class="even">
<td>MSE</td>
<td align="right">149617.9733</td>
<td align="right">8299.37115</td>
</tr>
<tr class="odd">
<td>MAPE</td>
<td align="right">115.5171</td>
<td align="right">19.16284</td>
</tr>
<tr class="even">
<td>RMSE</td>
<td align="right">386.8048</td>
<td align="right">91.10088</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="creating-your-own-model-sarimatd-1" class="section level1">
<h1><strong>Creating your own Model</strong>: SARIMATD</h1>
<div id="creating-your-own-model" class="section level3">
<h3>Creating your Own Model</h3>
<p>This Tutorial will demonstrate how to create a basic model with ForecastFramework. Models are created with R Object-Oriented programming, or the <a href="https://cran.r-project.org/web/packages/R6/vignettes/Introduction.html">R6 package</a>. It is essential to have a basic understanding of the structure of R6 Objects, before creating a ForecastFramework package. In this tutorial, the SARIMATD model will be created step-by-step.</p>
</div>
<div id="sarimatd" class="section level3">
<h3>SARIMATD</h3>
<p>SARIMATD is a model created by Evan Ray of the Reich Lab. SARIMATD uses set of wrapper functions around the forecast package to simplify estimation of and prediction from SARIMA models.</p>
<p>Basic Steps of the Model:</p>
<ol style="list-style-type: decimal">
<li>Incidence data are transformed to approximate normality</li>
<li>Seasonal differencing is performed</li>
<li>Transformed data are passed to <code>forecast::auto.arima</code> for model selection and estimation simulate trajectories of future incidence</li>
</ol>
</div>
<div id="building-the-sarimatd-model" class="section level3">
<h3>Building the SARIMATD Model</h3>
<div id="start-with-an-empty-model" class="section level4">
<h4>1. Start with an Empty Model</h4>
<p>ForecastFramework models all have the same basic structure:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">model &lt;-<span class="st"> </span><span class="kw">R6Class</span>(
  <span class="dt">inherit =</span> ContestModel, <span class="co"># or AggregateModel</span>
  <span class="dt">private =</span> <span class="kw">list</span>(
    <span class="co">#&#39; @method private section is for aspects we do not want the user to access directly</span>
  ),
  <span class="dt">public =</span> <span class="kw">list</span>(
    <span class="co">#&#39; @method fit_ Get the model ready to predict</span>
    <span class="co">#&#39; @param data The data to fit the model to.</span>
    <span class="dt">fit =</span> <span class="cf">function</span>(data){
      ...
    },
    <span class="co">#&#39; @method forecast Predict some number of time steps into the future.</span>
    <span class="co">#&#39; @param newdata The data to forecast from</span>
    <span class="co">#&#39; @param steps The number of timesteps into the future to predict.</span>
    <span class="dt">forecast =</span> <span class="cf">function</span>(newdata,steps){
      ...
    },
    <span class="co">#&#39; @method initialize Create a new instance of this class. </span>
    <span class="dt">initialize =</span> <span class="cf">function</span>(){
      ...
    },
    <span class="co">#&#39; @method predict predict using the model.</span>
    <span class="co">#&#39; @param newdata Predict using the model.</span>
    <span class="dt">predict =</span> <span class="cf">function</span>(newdata){
      ...
    },
  )
)</code></pre></div>
</div>
<div id="define-your-fit-and-forecast-functions" class="section level4">
<h4>2. Define your <code>fit()</code> and <code>forecast()</code> functions</h4>
<p>The easiest way to incorporate a model into ForecastFramework is to pre-define your fit and forecast functions in a separate package, or use a separate package like the <code>forecast</code> package. The <a href="https://github.com/reichlab/sarimaTD">SARMATD package</a> is hosted on Github and available for download with CRAN.</p>
<p>The SARIMATD fit function is as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @param y a univariate time series or numeric vector.</span>
<span class="co">#&#39; @param ts_frequency frequency of time series.  Must be provided if y is not</span>
<span class="co">#&#39;   of class &quot;ts&quot;.  See the help for stats::ts for more.</span>
<span class="co">#&#39; @param transformation character specifying transformation type:</span>
<span class="co">#&#39;   &quot;box-cox&quot;, &quot;log&quot;, &quot;forecast-box-cox&quot;, or &quot;none&quot;.  See details for more.</span>
<span class="co">#&#39; @param seasonal_difference boolean; take a seasonal difference before passing</span>
<span class="co">#&#39;   to auto.arima?</span>
<span class="co">#&#39; @param auto.arima_d order of first differencing argument to auto.arima.</span>
<span class="co">#&#39; @param auto.arima_D order of seasonal differencing argument to auto.arima.</span>
<span class="kw">fit_sarima</span>(
          y,
          ts_frequency,
          <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
          <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>,
          <span class="dt">d =</span> <span class="ot">NA</span>,
          <span class="dt">D =</span> <span class="ot">NA</span>)</code></pre></div>
<p>The SARIMATD forecast function is as follows (note that SARIMATD is a simulated forecast):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#&#39; @param object a sarima fit of class &quot;sarima_td&quot;, as returned by fit_sarima</span>
<span class="co">#&#39; @param nsim number of sample trajectories to simulate</span>
<span class="co">#&#39; @param seed either `NULL` or an integer that will be used in a call to</span>
<span class="co">#&#39;   `set.seed` before simulating the response vectors.  If set, the value is</span>
<span class="co">#&#39;   saved as the &quot;seed&quot; attribute of the returned value.  The default, `Null`,</span>
<span class="co">#&#39;   will not change the random generator state, and return `.Random.seed`</span>
<span class="co">#&#39;   as the &quot;seed&quot; attribute</span>
<span class="co">#&#39; @param newdata new data to simulate forward from</span>
<span class="co">#&#39; @param h number of time steps forwards to simulate</span>
<span class="co">#&#39;</span>
<span class="co">#&#39; @return an nsim by h matrix with simulated values</span>
<span class="kw">simulate.sarimaTD</span>(
                  object,
                  <span class="dt">nsim =</span> <span class="dv">1</span>,
                  <span class="dt">seed =</span> <span class="ot">NULL</span>,
                  newdata,
                  <span class="dt">h =</span> <span class="dv">1</span>)</code></pre></div>
</div>
<div id="update-the-r6-private-section" class="section level4">
<h4>3. Update the R6 Private Section</h4>
<p>This section of the Model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> private =<span class="st"> </span><span class="kw">list</span>(
    <span class="co">#&#39; @method private section is for aspects we do not want the user to access directly</span>
  ),</code></pre></div>
<p>Will become:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  private =<span class="st"> </span><span class="kw">list</span>(
    <span class="dt">.data =</span> <span class="ot">NULL</span>,        ## every model should have this
    <span class="dt">.models =</span> <span class="kw">list</span>(),    ## specific to models that are fit separately for each location
    <span class="dt">.nsim =</span> <span class="dv">1000</span>,         ## models that are simulating forecasts need this
    <span class="dt">.lambda =</span> <span class="kw">list</span>(),    ## specific to ARIMA models
    <span class="dt">.period =</span> <span class="kw">integer</span>(<span class="dv">0</span>) ## specific to SARIMA models
  ),</code></pre></div>
</div>
<div id="update-the-fit-method" class="section level4">
<h4>4. Update the fit Method</h4>
<p>Upload IncidenceMatrix to Fit function:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> fit =<span class="st"> </span><span class="cf">function</span>(data) {
      ## All fit functions should have this, it helps with debugging
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
      
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
 }</code></pre></div>
<p>Cycle though each province and use the <code>fit_sarima()</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> fit =<span class="st"> </span><span class="cf">function</span>(data) {
      ## All fit functions should have this, it helps with debugging
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
    
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
      ## for each location/row
      <span class="cf">for</span> (row_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>private<span class="op">$</span>.data<span class="op">$</span>nrow) {
        ### need to create a y vector with incidence at time t
        y &lt;-<span class="st"> </span>private<span class="op">$</span>.data<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> row_idx, <span class="dt">mutate =</span> <span class="ot">FALSE</span>)
        
        ## private$.models[[row_idx]] &lt;- something
        y_ts &lt;-<span class="st"> </span><span class="kw">ts</span>(<span class="kw">as.vector</span>(y<span class="op">$</span>mat), <span class="dt">frequency =</span> private<span class="op">$</span>.period)
        private<span class="op">$</span>.lambda[[row_idx]] &lt;-<span class="st"> </span><span class="kw">BoxCox.lambda</span>(y_ts)
        private<span class="op">$</span>.models[[row_idx]] &lt;-<span class="st"> </span><span class="kw">fit_sarima</span>(<span class="dt">y =</span> y_ts,
                                                 <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
                                                 <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>)
      }
 }</code></pre></div>
</div>
<div id="update-the-forecast-method" class="section level4">
<h4>4. Update the forecast Method</h4>
<p>Using the pre-defined equation <code>simulate.sarimaTD()</code> for the forecast method. <code>nmodels</code>, <code>sim_forecasts</code> and <code>dimnames(simforecasts)</code> are all variables needed to define a simulated forecast in ForecastFramework.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    forecast =<span class="st"> </span><span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
    }</code></pre></div>
<p>Now, the Provinces are iterated through and simulated with the <code>simulate.sarimaTD()</code>function (called as just <code>simulate()</code>). Then, there are a couple of matrix transformations to input the simulated matrix into the <code>SimulatedIncidenceMatrix()</code> Object.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">    forecast =<span class="st"> </span><span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
      ## iterate through each province and forecast with simulate.satimaTD
      <span class="cf">for</span>(model_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(private<span class="op">$</span>.models)) {
          tmp_arima &lt;-<span class="st">  </span><span class="kw">simulate</span>(<span class="dt">object =</span> private<span class="op">$</span>.models[[model_idx]],
                                 <span class="dt">nsim =</span> private<span class="op">$</span>.nsim,
                                 <span class="dt">seed =</span> <span class="dv">1</span>,
                                 <span class="dt">newdata =</span> <span class="kw">as.vector</span>(newdata<span class="op">$</span>mat[model_idx,]),
                                 <span class="dt">h =</span> steps
                                )
          ## transpose simulate() output to be consistent with ForecastFramework
          tmp_arima &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_arima)
          sim_forecasts[model_idx, , ] &lt;-<span class="st"> </span>tmp_arima
      }
      private<span class="op">$</span>output &lt;-<span class="st"> </span>SimulatedIncidenceMatrix<span class="op">$</span><span class="kw">new</span>(sim_forecasts)
      <span class="kw">return</span>(IncidenceForecast<span class="op">$</span><span class="kw">new</span>(private<span class="op">$</span>output, <span class="dt">forecastTimes =</span> <span class="kw">rep</span>(<span class="ot">TRUE</span>, steps)))
    }</code></pre></div>
</div>
<div id="update-the-initialize-method" class="section level4">
<h4>5. Update the initialize Method</h4>
<p>The initialize method is to initialize inputs. In this case, one input that needs initialization is the period (number of biweeks).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">initialize =<span class="st"> </span><span class="cf">function</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim=</span><span class="dv">1000</span>) { 
      ## this code is run during SARIMAModel$new()
      ## need to store these arguments within the model object
      private<span class="op">$</span>.nsim &lt;-<span class="st"> </span>nsim
      private<span class="op">$</span>.period &lt;-<span class="st"> </span>period
    },</code></pre></div>
</div>
<div id="update-the-active-section" class="section level4">
<h4>6. Update the active section</h4>
<p>This section determines what users can change in the model:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">active =<span class="st"> </span><span class="kw">list</span>(
    ## This list determines how you can access pieces of your model object
    <span class="dt">data =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the data is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.data)
    },
    <span class="dt">models =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the models is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.models)
    },
    <span class="dt">nsim =</span> <span class="cf">function</span>(value) {
      ## use this form when you want to be able to change this parameter
      private<span class="op">$</span><span class="kw">defaultActive</span>(<span class="dt">type=</span><span class="st">&quot;private&quot;</span>, <span class="st">&quot;.nsim&quot;</span>, <span class="dt">val=</span>value)
    },
    <span class="dt">lambda =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to lambda is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.lambda)
    },
    <span class="dt">period =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the model period is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.period)
    }
  )</code></pre></div>
</div>
<div id="putting-everything-together" class="section level4">
<h4>7. Putting everything Together</h4>
<p>All of the previous sections and methods are put together as the R6 Object:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(ForecastFramework)
<span class="kw">library</span>(R6)
<span class="kw">library</span>(forecast)
<span class="kw">library</span>(sarimaTD)

<span class="co"># SARIMATDModel Description:</span>
<span class="co"># Implementation of the sarimaTD model created by Evan Ray</span>
<span class="co"># More information about sarimaTD in https://github.com/reichlab/sarimaTD </span>
<span class="co"># Integrated into ForecastFramework by: Katie House, 6/22/2018</span>

SARIMATD1Model &lt;-<span class="st"> </span><span class="kw">R6Class</span>(
  <span class="dt">inherit =</span> ContestModel,
  <span class="dt">private =</span> <span class="kw">list</span>(
    <span class="dt">.data =</span> <span class="ot">NULL</span>,        ## every model should have this
    <span class="dt">.models =</span> <span class="kw">list</span>(),    ## specific to models that are fit separately for each location
    <span class="dt">.nsim =</span> <span class="dv">1000</span>,        ## models that are simulating forecasts need this
    <span class="dt">.period =</span> <span class="kw">integer</span>(<span class="dv">0</span>) ## specific to SARIMA models
  ),
  <span class="dt">public =</span> <span class="kw">list</span>(
    ## data will be MatrixData
    <span class="dt">fit =</span> <span class="cf">function</span>(data) {
      <span class="cf">if</span>(<span class="st">&quot;fit&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()}
      ## stores data for easy access and checks to make sure it&#39;s the right class
      private<span class="op">$</span>.data &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(data)
      
      ## for each location/row
      <span class="cf">for</span> (row_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>private<span class="op">$</span>.data<span class="op">$</span>nrow) {
        ### need to create a y vector with incidence at time t
        y &lt;-<span class="st"> </span>private<span class="op">$</span>.data<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> row_idx, <span class="dt">mutate =</span> <span class="ot">FALSE</span>)
        
        ## convert y vector to time series data type
        y_ts &lt;-<span class="st"> </span><span class="kw">ts</span>(<span class="kw">as.vector</span>(y<span class="op">$</span>mat), <span class="dt">frequency =</span> private<span class="op">$</span>.period)
        
        ## fit sarimaTD with &#39;fit_sarima()&#39; from sarimaTD package
        ## fit_sarima() performs box-cox transformation and seasonal differencing
        private<span class="op">$</span>.models[[row_idx]] &lt;-<span class="st"> </span><span class="kw">fit_sarima</span>(<span class="dt">y =</span> y_ts,
                                                 <span class="dt">transformation =</span> <span class="st">&quot;box-cox&quot;</span>,
                                                 <span class="dt">seasonal_difference =</span> <span class="ot">TRUE</span>)
      }
    },
    <span class="dt">forecast =</span> <span class="cf">function</span>(<span class="dt">newdata =</span> private<span class="op">$</span>.data, steps) {
      ## include for debugging
      <span class="cf">if</span>(<span class="st">&quot;forecast&quot;</span> <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>.debug){<span class="kw">browser</span>()} 
      
      ## number of models (provinces) to forecast
      nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(private<span class="op">$</span>.models)
      
      ## define an array to store the simulated forecasts
      sim_forecasts &lt;-<span class="st"> </span><span class="kw">array</span>(<span class="dt">dim =</span> <span class="kw">c</span>(nmodels, steps, private<span class="op">$</span>.nsim))
      <span class="kw">dimnames</span>(sim_forecasts) &lt;-<span class="st"> </span><span class="kw">list</span>(newdata<span class="op">$</span>rnames, <span class="dv">1</span><span class="op">:</span>steps, <span class="ot">NULL</span>)
      
      ## iterate through each province and forecast with simulate.satimaTD
      <span class="cf">for</span>(model_idx <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="kw">length</span>(private<span class="op">$</span>.models)) {
          tmp_arima &lt;-<span class="st">  </span><span class="kw">simulate</span>(<span class="dt">object =</span> private<span class="op">$</span>.models[[model_idx]],
                                 <span class="dt">nsim =</span> private<span class="op">$</span>.nsim,
                                 <span class="dt">seed =</span> <span class="dv">1</span>,
                                 <span class="dt">newdata =</span> <span class="kw">as.vector</span>(newdata<span class="op">$</span>mat[model_idx,]),
                                 <span class="dt">h =</span> steps
                                )
          ## transpose simulate() output to be consistent with ForecastFramework
          tmp_arima &lt;-<span class="st"> </span><span class="kw">t</span>(tmp_arima)
          sim_forecasts[model_idx, , ] &lt;-<span class="st"> </span>tmp_arima
      }
      private<span class="op">$</span>output &lt;-<span class="st"> </span>SimulatedIncidenceMatrix<span class="op">$</span><span class="kw">new</span>(sim_forecasts)
      <span class="kw">return</span>(IncidenceForecast<span class="op">$</span><span class="kw">new</span>(private<span class="op">$</span>output, <span class="dt">forecastTimes =</span> <span class="kw">rep</span>(<span class="ot">TRUE</span>, steps)))
    },
    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim=</span><span class="dv">1000</span>) { 
      ## this code is run during SARIMAModel$new()
      ## need to store these arguments within the model object
      private<span class="op">$</span>.nsim &lt;-<span class="st"> </span>nsim
      private<span class="op">$</span>.period &lt;-<span class="st"> </span>period
    },
    <span class="dt">predict =</span> <span class="cf">function</span>(newdata) {
      <span class="kw">stop</span>(<span class="st">&quot;predict method has not been written.&quot;</span>)
    }
  ),
  <span class="dt">active =</span> <span class="kw">list</span>(
    ## This list determines how you can access pieces of your model object
    <span class="dt">data =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the data is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.data)
    },
    <span class="dt">models =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the models is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.models)
    },
    <span class="dt">nsim =</span> <span class="cf">function</span>(value) {
      ## use this form when you want to be able to change this parameter
      private<span class="op">$</span><span class="kw">defaultActive</span>(<span class="dt">type=</span><span class="st">&quot;private&quot;</span>, <span class="st">&quot;.nsim&quot;</span>, <span class="dt">val=</span>value)
    },
    <span class="dt">period =</span> <span class="cf">function</span>(value) {
      ## use this form when you want this parameter to be un-modifiable
      <span class="cf">if</span>(<span class="op">!</span><span class="kw">missing</span>(value))
        <span class="kw">stop</span>(<span class="st">&quot;Writing directly to the model period is not allowed.&quot;</span>)
      <span class="kw">return</span>(private<span class="op">$</span>.period)
    }
  )
)</code></pre></div>
</div>
<div id="testing-the-new-model" class="section level4">
<h4>8. Testing the New Model</h4>
<p>Lets now test the model on the same biweek counts as the SARIMA demo. The output is a forecasted case count for 26 biweeks.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># training data for province 10, years 2006 - 2012 </span>
dat &lt;-<span class="st"> </span><span class="kw">read.csv</span>(<span class="st">&#39;../data/province-biweek-counts-training.csv&#39;</span>)
dat<span class="op">$</span>date_sick &lt;-<span class="st"> </span><span class="kw">as.Date</span>(<span class="kw">strptime</span>(dat<span class="op">$</span>date_sick,<span class="st">&quot;%m/%d/%Y&quot;</span>)) <span class="co"># convert to date values</span>
inc &lt;-<span class="st"> </span>IncidenceMatrix<span class="op">$</span><span class="kw">new</span>(<span class="dv">1</span><span class="op">+</span>reshape2<span class="op">::</span><span class="kw">acast</span>(dat,province<span class="op">~</span>date_sick,<span class="dt">value.var=</span><span class="st">&#39;cases&#39;</span>))

<span class="co"># define how many provinces to model</span>
<span class="co"># this demo only has data for one province: Province 10</span>
nsim &lt;-<span class="st"> </span><span class="dv">1000</span> <span class="co"># Number of SARIMA simulations </span>
sarimaTD_model &lt;-<span class="st"> </span>SARIMATD1Model<span class="op">$</span><span class="kw">new</span>(<span class="dt">period =</span> <span class="dv">26</span>, <span class="dt">nsim =</span> nsim)

prov_nums &lt;-<span class="st"> </span><span class="dv">1</span>
nmodels &lt;-<span class="st"> </span><span class="kw">length</span>(prov_nums)
sarimaTD_model<span class="op">$</span><span class="kw">fit</span>(inc<span class="op">$</span><span class="kw">subset</span>(<span class="dt">rows =</span> prov_nums, <span class="dt">mutate =</span> <span class="ot">FALSE</span>))

<span class="co"># define how many provinces to model</span>
<span class="co"># this demo only has data for one province: Province 10</span>
steps &lt;-<span class="st"> </span><span class="dv">26</span> <span class="co"># forecast ahead 26 biweeks</span>

forecast_X &lt;-<span class="st"> </span>sarimaTD_model<span class="op">$</span><span class="kw">forecast</span>(<span class="dt">steps =</span> steps)

<span class="kw">print</span>(forecast_X<span class="op">$</span>data<span class="op">$</span>mat)</code></pre></div>
<pre><code>##           1       2        3        4        5        6        7        8
## 10 327.7927 270.758 173.5653 337.1071 242.0536 165.6722 169.9746 263.4689
##           9       10       11       12       13       14       15       16
## 10 280.1253 257.2469 474.2574 431.1961 445.1189 249.1284 482.9424 384.7416
##          17      18       19       20       21       22       23       24
## 10 422.9699 522.987 482.7025 491.8881 631.0708 845.1356 848.3478 466.7607
##          25       26
## 10 556.8699 227.3426</code></pre>
</div>
</div>
</div>

    </div>
    <div class="col-xs-2">
        </div>
  </div>
  </div>
  </div>
  <div class="row">
    </div>
  </div>

<script>
$(document).ready(function () {
  // add bootstrap table styles to pandoc tables
  $('tr.header').parent('thead').parent('table').addClass('table table-striped table-hover');

    var images = $('.pages img');
  images.filter(function() {
      if ($(this).parent().attr("class") == "figure") {
          return(false)
      } else {
          return(true);
      }
  }).wrap("<div class='figure'></div>");
  images.addClass("image-thumb").wrap("<div class='panel-body'></div>");
  $('.figure p.caption').wrap("<div class='panel-footer'></div>");
  $('.figure').addClass('panel panel-default');
  
    $('.pages img')
 	  .addClass("image-lb");
  $('.pages').magnificPopup({
	      type:'image',
	      closeOnContentClick: false,
	      delegate: 'img',
	      gallery: {enabled: false },
          removalDelay: 500,
          callbacks: {
              beforeOpen: function() {
                // just a hack that adds mfp-anim class to markup
                this.st.image.markup = this.st.image.markup.replace('mfp-figure', 'mfp-figure mfp-with-anim');
              }
          },
          mainClass: 'mfp-move-from-top',
	      image: {
	        verticalFit: true,
            titleSrc: 'alt'
	      }
 	    });
 	
    window.page = window.location.hash;
    if (window.page != "") {
      $(".menu").find("li[data-target=" + window.page + "]").trigger("click");
    }

    /* init material bootstrap js */
    $.material.init();
});
</script>




<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
